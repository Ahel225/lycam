<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
  <title>Gestionnaire d'Élèves Pro — v5.6</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <style>
  :root { 
    --bg:#f1f5f9; 
    --surface:#ffffff; 
    --surface-2:#f8fafc; 
    --text:#0f172a; 
    --text-muted:#64748b; 
    --border:#e2e8f0; 
    --brand:#0ea5e9; 
    --brand-dark:#0284c7; 
    --brand-light:#e0f2fe; 
    --accent:#10b981; 
    --warn:#f59e0b;
    --danger:#ef4444; 
    --lycam-color:#6366f1; 
    --registry-color:#8b5cf6;
    --tracking-color:#db2777; 
    --shadow:0 1px 3px 0 rgb(0 0 0 / 0.1), 0 1px 2px -1px rgb(0 0 0 / 0.1); 
  }
  
  *{box-sizing:border-box} 
  html,body{height:100%} 
  body{margin:0;background:var(--bg);color:var(--text);font-family:ui-sans-serif,system-ui,-apple-system,sans-serif;font-size:14px;line-height:1.4;}
  
  ::-webkit-scrollbar { width: 6px; height: 6px; }
  ::-webkit-scrollbar-track { background: transparent; }
  ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
  ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }

  .container{max-width:1400px;margin:0 auto;padding:16px;height:100%;display:flex;flex-direction:column;gap: 16px;}
  .header{display:flex;align-items:center;justify-content:space-between;margin-bottom:0}
  .brand{display:flex;align-items:center;gap:10px}
  .logo{width:36px;height:36px;border-radius:8px;background:linear-gradient(135deg,var(--brand),#38bdf8);display:flex;align-items:center;justify-content:center;color:white;font-size:16px;font-weight:bold;}
  
  .card{background:var(--surface);border:1px solid var(--border);border-radius:10px;padding:16px;box-shadow:var(--shadow);display: flex;flex-direction: column;}
  .section { flex:1; min-height:0; } 
  
  .toolbar{display:flex;flex-wrap:wrap;gap:12px;align-items:center;padding:12px;background:var(--surface-2);border-radius:8px;border:1px solid var(--border);margin-top:10px;}
  .toolbar-roster {display: flex;gap: 10px;margin-bottom: 12px;align-items: center;}
  
  .field{display:flex;flex-direction:column;gap:4px;}
  .label{font-size:10px;color:var(--text-muted);font-weight:700;text-transform:uppercase;letter-spacing:0.5px;}
  .input,.select,.textarea{padding:8px 10px;border-radius:6px;border:1px solid var(--border);background:#fff;font-size:13px;color:var(--text);width:100%;transition:border 0.2s;}
  .input:focus, .select:focus {outline:none;border-color:var(--brand);box-shadow:0 0 0 2px var(--brand-light);}
  
  .btn{display:inline-flex;align-items:center;justify-content:center;gap:6px;padding:8px 14px;border:0;border-radius:6px;background:var(--brand);color:#fff;font-weight:600;cursor:pointer;transition:all 0.2s;font-size:13px;}
  .btn:hover{filter:brightness(95%);transform:translateY(-1px);}
  .btn.ghost{background:transparent;border:1px solid var(--border);color:var(--text-muted);}
  .btn.ghost:hover{background:#fff;border-color:var(--brand);color:var(--brand);}
  
  .btn.lycam-btn { background: var(--lycam-color); color: white; }
  .btn.registry-btn { background: var(--registry-color); color: white; }
  .btn.tracking-btn { background: var(--tracking-color); color: white; }
  
  .table-wrap{overflow:auto; border-radius:8px; border:1px solid var(--border); background:var(--surface); flex-grow: 1;}
  table{width:100%;border-collapse:separate;border-spacing:0;font-size:13px;}
  thead th{position:sticky;top:0;background:var(--surface-2);padding:10px 8px;font-weight:700;text-align:left;border-bottom:1px solid var(--border);white-space:nowrap;z-index:10;color:var(--text-muted);}
  tbody td{padding:8px 8px;border-bottom:1px solid var(--border);vertical-align:middle;}
  tbody tr:hover{background:var(--brand-light);cursor: pointer;}

  /* Colonnes */
  #roster tbody td:nth-child(1) { width: 90px; color:var(--text-muted); font-family: 'Courier New', monospace; font-size:12px; }
  #roster tbody td:nth-child(2) { color: var(--text); width: 250px; }
  #roster tbody td:nth-child(3) { width: 80px; }
  #roster tbody td:nth-child(4) { width: 50px; text-align:center; }
  #roster tbody td:nth-child(5) { width: 100px; text-align:center; color:var(--text-muted); }
  #roster tbody td:nth-child(6) { width: 50px; text-align:center; } 

  .name-part { font-weight: 800; color: var(--brand-dark); text-transform: uppercase; margin-right: 6px; }
  .grid-container {display: flex;flex-direction: column;flex-grow: 1;height: 100%;overflow: hidden;}

  .badge{padding:2px 8px;border-radius:99px;font-size:11px;font-weight:600;}
  .chip{display:inline-flex;align-items:center;gap:6px;padding:4px 10px;border-radius:20px;background:var(--surface);border:1px solid var(--border);font-size:12px;font-weight:600;color:var(--text-muted);}
  

.tabs::-webkit-scrollbar-track {
  background: transparent;
  border-radius: 10px;
}

.tabs::-webkit-scrollbar-thumb {
  background: var(--border);
  border-radius: 10px;
}

.tabs::-webkit-scrollbar-thumb:hover {
  background: var(--brand);
}

/* Assurez-vous que les tab sont assez larges et ne se rétrécissent pas */
.tab {
  padding: 10px 18px;
  border-radius: 6px;
  cursor: pointer;
  font-weight: 600;
  font-size: 13px;
  color: var(--text-muted);
  flex: 0 0 auto; /* IMPORTANT : empêche le rétrécissement */
  text-align: center;
  min-width: 120px;
  transition: all 0.2s;
  user-select: none;
}

.tab:hover {
  background: rgba(255, 255, 255, 0.5);
}

.tab.active {
  background: var(--surface);
  color: var(--brand);
  box-shadow: var(--shadow);
  font-weight: 700;
}

/* Améliorations spécifiques pour mobile */
@media (max-width: 768px) {
  .tabs {
    gap: 4px;
    padding: 6px 2px;
    margin-bottom: 12px;
    min-height: 44px;
  }
  
  .tab {
    padding: 12px 16px;
    min-width: 140px;
    font-size: 14px;
  }
  
  /* Pour les onglets avec texte long */
  #lycamMainPanel .tab,
  #trackingGlobalPanel .tab {
    min-width: 160px;
  }
  
  /* Assurez-vous que les conteneurs permettent le scroll */
  #lycamMainPanel,
  #trackingGlobalPanel,
  #registryPanel,
  #studentPanel {
    display: flex;
    flex-direction: column;
    overflow: hidden;
    height: 100%;
  }
}

/* Assurez-vous que le conteneur principal permet le scroll */
.grid-container {
  display: flex;
  flex-direction: column;
  flex: 1;
  min-height: 0;
  overflow: hidden;
  height: 100%;
}

/* Pour les panneaux spécifiques avec onglets */
#lycamMainPanel,
#trackingGlobalPanel {
  display: flex;
  flex-direction: column;
  height: 100%;
}

/* Conteneurs de contenu des onglets - assurez le scroll vertical */
#lycam-view-candidates,
#lycam-view-results,
#track-view-visits,
#track-view-coaching,
#tab-identity,
#tab-grades,
#tab-visits,
#tab-coaching {
  flex: 1;
  overflow-y: auto;
  overflow-x: hidden;
  -webkit-overflow-scrolling: touch;
  min-height: 0;
}

/* Correction spécifique pour la table des candidats LYCAM */
#lycam-view-candidates .table-wrap,
#lycam-view-results .table-wrap {
  flex: 1;
  min-height: 0;
  overflow: auto;
}

  .modal{display:none;position:fixed;inset:0;background:rgba(15,23,42,0.5);z-index:9999;backdrop-filter:blur(2px);padding:10px;align-items:center;justify-content:center;}
  .modal-content{background:var(--surface);width:100%;max-width:600px;max-height:90vh;display:flex;flex-direction:column;border-radius:16px;box-shadow:0 20px 25px -5px rgb(0 0 0 / 0.1);animation:slideUp 0.3s cubic-bezier(0.16, 1, 0.3, 1);}
  .modal-body{overflow-y:auto;padding:24px;flex:1;}
  .modal-footer{padding:16px 24px;border-top:1px solid var(--border);display:flex;justify-content:flex-end;gap:10px;background:var(--surface-2);border-radius:0 0 16px 16px;}
  @keyframes slideUp{from{transform:translateY(20px);opacity:0}to{transform:translateY(0);opacity:1}}

  /* LYCAM Styles */
  .question-block { margin-bottom: 20px; padding-bottom: 15px; border-bottom: 1px dashed var(--border); }
  .question-text { font-weight: 600; margin-bottom: 8px; font-size: 14px; }
  .option-label { display: block; padding: 4px 0; cursor: pointer; color: var(--text-muted); }
  .option-label:hover { color: var(--brand); }
  .risk-badge { background: #fee2e2; color: #dc2626; border:1px solid #fecaca; }
  .ok-badge { background: #dcfce7; color: #16a34a; border:1px solid #bbf7d0; }
  .dim-score-box { display:inline-flex; font-size:10px; font-family:'Courier New', monospace; font-weight:bold; border:1px solid #e2e8f0; padding:1px 4px; border-radius:4px; margin-right:2px; margin-bottom:2px;}
  
  @media (max-width: 768px){
      .container { padding: 10px; }
      .toolbar { flex-direction: column; align-items: stretch; }
      .toolbar-roster { flex-wrap: wrap; }
      #search { width: 100%; }
  }
  /* Dans la section des styles CSS, remplacez ou ajoutez : */
#studentPanel {
  display: flex;
  flex-direction: column;
  height: 100%;
  overflow: hidden;
}

#studentPanel .tabs {
  flex-shrink: 0;
}

#studentPanel > div[id^="tab-"] {
  flex: 1;
  overflow-y: auto;
  min-height: 0;
}

#tab-grades .table-wrap {
  max-height: 100%;
  height: calc(100vh - 300px);
}

#grades-table {
  margin-bottom: 20px;
}

/* Ajoutez cette règle pour le conteneur principal */
.grid-container {
  display: flex;
  flex-direction: column;
  flex: 1;
  min-height: 0;
  overflow: hidden;
}

/* Modifiez la section .tabs */
.tabs {
  display: flex;
  gap: 4px;
  padding: 4px;
  background: var(--surface-2);
  border-radius: 8px;
  margin-bottom: 16px;
  overflow-x: auto;
  -webkit-overflow-scrolling: touch; /* Pour un défilement fluide sur iOS */
  scrollbar-width: none; /* Masquer la scrollbar sur Firefox */
  white-space: nowrap;
}

.tabs::-webkit-scrollbar {
  display: none; /* Masquer la scrollbar sur Chrome/Safari */
}

.tab {
  padding: 8px 16px;
  border-radius: 6px;
  cursor: pointer;
  font-weight: 600;
  font-size: 13px;
  color: var(--text-muted);
  flex: 0 0 auto; /* Empêche le redimensionnement automatique */
  text-align: center;
}

/* Pour les onglets spécifiques dans les panneaux */
#lycamMainPanel .tabs,
#trackingGlobalPanel .tabs,
#studentPanel .tabs {
  min-height: 44px; /* Taille minimum pour le touch */
}

/* Amélioration du touch sur mobile */
@media (max-width: 768px) {
  .tab {
    padding: 12px 20px; /* Plus grand pour le touch */
    min-width: 140px; /* Largeur minimum pour être cliquable */
  }
  
  /* Assurez-vous que les panneaux avec onglets sont bien dimensionnés */
  #lycamMainPanel,
  #trackingGlobalPanel,
  #registryPanel,
  #studentPanel {
    overflow: hidden;
    display: flex;
    flex-direction: column;
  }
  
  /* Conteneur de contenu des onglets */
  #lycam-view-candidates,
  #lycam-view-results,
  #track-view-visits,
  #track-view-coaching,
  #tab-identity,
  #tab-grades,
  #tab-visits,
  #tab-coaching {
    flex: 1;
    overflow-y: auto;
    -webkit-overflow-scrolling: touch;
  }
}

/* Styles pour les tabs des statistiques */
#stats-tabs {
    margin-bottom: 16px;
}

#stats-overview,
#stats-topbottom,
#stats-gender,
#stats-orientation {
    flex: 1;
    min-height: 0;
    overflow-y: auto;
}

/* Responsive pour les stats */
@media (max-width: 768px) {
    #stats-tabs .tab {
        min-width: 120px;
        padding: 10px 12px;
    }
    
    #stats-overview,
    #stats-topbottom,
    #stats-gender,
    #stats-orientation {
        padding: 8px 0;
    }
}
/* Styles pour les barres de statistiques */
.stat-bar-container {
  height: 8px;
  background: #e2e8f0;
  border-radius: 4px;
  overflow: hidden;
  margin-top: 6px;
  width: 100%;
}
.stat-bar-fill {
  height: 100%;
  border-radius: 4px;
  transition: width 0.5s ease;
}
.stat-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
    gap: 16px;
}
.kpi-card {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 16px;
    box-shadow: 0 1px 2px rgba(0,0,0,0.05);
}
.kpi-value { font-size: 24px; font-weight: 800; color: var(--text); }
.kpi-label { font-size: 12px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px; }
/* Ajouter ces styles dans la section CSS LYCAM */
.question-block.missing {
    border: 2px solid var(--danger) !important;
    background-color: rgba(239, 68, 68, 0.05) !important;
    padding: 12px;
    border-radius: 8px;
    animation: pulse 1.5s infinite;
}

@keyframes pulse {
    0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.4); }
    70% { box-shadow: 0 0 0 10px rgba(239, 68, 68, 0); }
    100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); }
}

.question-block.missing .question-text {
    color: var(--danger) !important;
    font-weight: 800 !important;
}

.missing-label {
    color: var(--danger) !important;
    font-weight: 600 !important;
}

.required-asterisk {
    color: var(--danger);
    font-weight: bold;
    margin-left: 2px;
}
  </style>
</head>
<body>

<div class="container">
  
  <header class="header">
    <div class="brand">
      <div class="logo">GE</div>
      <div>
        <div style="font-weight:800;font-size:18px">Gestionnaire d'Élèves</div>
        <div class="subtitle">v5.6 Koubi Seri Fils</div>
      </div>
    </div>
    <div class="chip" id="status"><i class="fa fa-check-circle" style="color:var(--accent)"></i> Prêt</div>
  </header>

  <section class="card" style="flex:0 0 auto;">
    <details>
      <summary style="cursor:pointer;font-weight:700;display:flex;align-items:center;gap:8px;color:var(--brand);font-size:13px">
        <i class="fa fa-sliders"></i> Configuration & Import
      </summary>
      <div class="toolbar">
        <button id="btn-generate-demo" class="btn" style="background:var(--warn); color:white">
    <i class="fa fa-magic"></i> Générer Données Démo
</button>
        <div class="field" style="flex:1;min-width:200px;">
          <label class="label">Importer Excel</label>
          <input id="excel-file" class="input" type="file" accept=".xlsx,.xls">
        </div>
        <div class="field" style="width:140px">
          <label class="label">Année scolaire</label>
          <select id="school-year" class="select">
            <option selected>2025-2026</option>
            <option>2024-2025</option>
          </select>
        </div>
        
        <div style="display:flex;gap:8px;margin-top:auto">
           <button id="btn-export-backup" class="btn ghost"><i class="fa fa-download"></i> Sauvegarder TOUT</button>
           <label class="btn ghost" style="cursor:pointer;margin:0">
             <i class="fa fa-upload"></i> Restaurer
             <input type="file" id="input-import-backup" accept=".json" style="display:none">
           </label>
        </div>
      </div>
    </details>
  </section>

  <div class="grid-container">

    <div id="rosterPanel" class="card section">
      <div class="toolbar-roster">
        <div style="display:flex;align-items:center;gap:8px;flex:1">
             <select id="class-filter" class="select" style="max-width:160px;font-weight:600">
                <option value="__ALL__">Toutes les classes</option>
            </select>
            <div style="position:relative;flex-grow:1;">
                <i class="fa fa-search" style="position:absolute;left:10px;top:50%;transform:translateY(-50%);color:var(--text-muted);font-size:12px"></i>
                <input id="search" class="input" placeholder="Rechercher..." style="padding-left:30px;width:100%">
            </div>
        </div>
        
        <div id="class-stats" class="chip"></div>

<div style="display:flex; overflow-x:auto; gap:4px; white-space:nowrap">
    <button id="refresh-roster" class="btn ghost" title="Actualiser"><i class="fa fa-sync"></i></button>
    <button id="btn-open-rankings" class="btn ghost" title="Classements"><i class="fa fa-list-ol"></i></button>
    <button id="btn-open-stats" class="btn ghost" title="Statistiques Globales"><i class="fa fa-chart-bar"></i> Stats</button>
    <button id="btn-open-lycam-main" class="btn lycam-btn" title="Gestion LYCAM"><i class="fa fa-clipboard-check"></i> LYCAM</button>
    <button id="btn-open-registry" class="btn registry-btn" title="Registre de visites"><i class="fa fa-address-book"></i> Registre</button>
    <button id="btn-open-tracking" class="btn tracking-btn" title="Suivi & Coaching Global"><i class="fa fa-hands-helping"></i> Suivi/Coach</button>
    
    <button id="btn-add-student" class="btn"><i class="fa fa-plus"></i></button>
</div>
      </div>

      <div class="table-wrap">
        <table id="roster">
          <thead>
            <tr>
              <th>Matricule</th>
              <th>Nom & Prénoms</th>
              <th>Classe</th>
              <th>Sexe</th>
              <th>Né(e) le</th>
              <th>Vue</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>

    <div id="studentPanel" class="card section" style="display:none; border-top:4px solid var(--brand)">
      
      <div style="display:flex;align-items:center;gap:12px;margin-bottom:16px;border-bottom:1px solid var(--border);padding-bottom:12px">
        <button id="backToListBtn" class="btn ghost"><i class="fa fa-arrow-left"></i> Retour</button>
        <div>
           <h2 id="st-name" style="margin:0;font-size:20px;color:var(--text)">Nom Prénoms</h2>
           <div style="color:var(--text-muted);font-size:12px;margin-top:2px">
              <span class="chip"><i class="fa fa-id-card"></i> <span id="st-mat">MAT</span></span>
              <span class="chip"><i class="fa fa-users"></i> <span id="st-class">CLASSE</span></span>
           </div>
        </div>
      </div>

      <div class="tabs">
        <div class="tab active" data-tab="identity">Identité</div>
        <div class="tab" data-tab="grades">Moyennes</div>
        <div class="tab" data-tab="visits">Suivi</div>
        <div class="tab" data-tab="coaching">Coaching</div>
      </div>

      <div id="tab-identity" style="display:block">
        <div style="display:grid;grid-template-columns:repeat(auto-fit, minmax(280px, 1fr)); gap:20px">
           <div>
              <h4 style="color:var(--text-muted);text-transform:uppercase;margin-top:0;font-size:12px">Informations</h4>
              <div class="field" style="margin-bottom:10px"><label class="label">Sexe</label><div id="st-sex" class="input" style="background:var(--surface-2)"></div></div>
              <div class="field"><label class="label">Né(e) le</label><div id="st-born" class="input" style="background:var(--surface-2)"></div></div>
           </div>
           <div style="background:var(--brand-light);padding:16px;border-radius:10px;border:1px solid rgba(14, 165, 233, 0.2)">
              <h4 style="margin-top:0;color:var(--brand-dark);font-size:14px">Synthèse Annuelle</h4>
              <div id="kpi-avg" style="font-size:14px;line-height:1.6;color:var(--text)"></div>
              <div style="margin-top:12px;padding-top:12px;border-top:1px solid rgba(0,0,0,0.05);display:flex;justify-content:space-between;align-items:center">
                 <div>Rang: <strong id="kpi-rank" style="font-size:16px"></strong></div>
                 <span id="kpi-status" class="badge"></span>
              </div>
           </div>
        </div>
      </div>

      <div id="tab-grades" style="display:none">
        <div class="table-wrap">
          <table id="grades-table">
            <thead><tr><th>Matière</th><th>1TR</th><th>2TR</th><th>3TR</th><th>Annuelle</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>
      </div>

      <div id="tab-visits" style="display:none">
        <div class="toolbar" style="margin:0 0 12px 0;border:none;background:transparent;padding:0">
           <input id="visit-at" type="date" class="input" style="width:auto">
           <input id="visit-reason" class="input" placeholder="Motif" style="flex:1">
           <button id="btn-add-visit" class="btn">Ajouter</button>
        </div>
        <textarea id="visit-details" class="textarea" placeholder="Détails de l'échange..." style="margin-bottom:12px"></textarea>
        <div class="table-wrap"><table id="visits-table"><thead><tr><th>Date</th><th>Détails</th></tr></thead><tbody></tbody></table></div>
      </div>

      <div id="tab-coaching" style="display:none">
        <div class="toolbar" style="margin:0 0 12px 0;border:none;background:transparent;padding:0">
           <select id="coach-status" class="select" style="width:120px"><option>En cours</option><option>Terminé</option><option>Abandonné</option></select>
           <input id="coach-actions" class="input" placeholder="Actions..." style="flex:1">
           <button id="btn-save-coach" class="btn">Sauver</button>
        </div>
        <div class="table-wrap"><table id="coach-table"><thead><tr><th>Date</th><th>Statut</th><th>Actions</th></tr></thead><tbody></tbody></table></div>
      </div>

    </div>

    <div id="rankingsPanel" class="card section" style="display:none; border-top:4px solid var(--accent)">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
          <h3><i class="fa fa-trophy" style="color:var(--warn)"></i> Classements</h3>
          <button class="btn ghost close-panel"><i class="fa fa-arrow-left"></i> Retour</button>
        </div>
        <div class="toolbar" style="margin-top:0;margin-bottom:12px">
          <div class="field"><label class="label">Période</label><select id="rank-scope" class="select"><option value="Annuelle">Annuelle</option><option value="1TR">1er Trimestre</option><option value="2TR">2e Trimestre</option><option value="3TR">3e Trimestre</option></select></div>
          <div class="field"><label class="label">Classe</label><select id="rank-class-filter" class="select"></select></div>
          <div class="field"><label class="label">Matière</label>
            <select id="subject-filter" class="select">
              <option value="Moy_generale">Moyenne G.</option>
              <option value="francais">Français</option>
              <option value="maths">Maths</option>
              <option value="anglais">Anglais</option>
              <option value="physique">Physique</option>
              <option value="svt">SVT</option>
              <option value="hg">Hist-Géo</option>
              <option value="eps">EPS</option>
              <option value="philosophie">Philo</option>
              <option value="lv2">LV2</option>
              <option value="conduite">Conduite</option>
              <option value="art_plastique">Arts</option>
            </select>
          </div>
        </div>
        <div id="rankings-container" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(400px,1fr));gap:12px;overflow-y:auto;padding-bottom:20px"></div>
    </div>
<div id="statsPanel" class="card section" style="display:none; border-top:4px solid var(--accent)">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
        <h3><i class="fa fa-chart-bar" style="color:var(--accent)"></i> Statistiques Globales</h3>
        <button class="btn ghost close-panel"><i class="fa fa-arrow-left"></i> Retour</button>
    </div>

    <div class="toolbar" style="margin-top:0; margin-bottom:15px; background:var(--brand-light); border-color:var(--brand)">
        <div class="field" style="flex-direction:row; align-items:center; gap:10px; width:100%">
            <label class="label" style="margin-bottom:0; color:var(--brand-dark)">Période analysée :</label>
            <select id="stats-period-selector" class="select" style="max-width:200px; font-weight:bold">
                <option value="1TR">1er Trimestre</option>
                <option value="2TR">2e Trimestre</option>
                <option value="3TR">3e Trimestre</option>
                <option value="Annuelle" selected>Annuelle</option>
            </select>
            <span style="font-size:11px; color:var(--text-muted); margin-left:auto"><i class="fa fa-info-circle"></i> Changez la période pour voir les données</span>
        </div>
    </div>
    
    <div class="tabs" id="stats-tabs">
        <div class="tab active" onclick="switchStatsView('overview')">Vue d'ensemble</div>
        <div class="tab" onclick="switchStatsView('repartition')">Répartition</div>
        <div class="tab" onclick="switchStatsView('topbottom')">Top & Bottom</div>
        <div class="tab" onclick="switchStatsView('gender')">Par Genre</div>
        <div class="tab" onclick="switchStatsView('orientation')">Orientation</div>
    </div>

    <div id="stats-overview" style="display:block; overflow-y:auto; padding:10px 0">
        <div id="overview-content"></div>
    </div>

    <div id="stats-repartition" style="display:none; overflow-y:auto; padding:10px 0">
        <div id="repartition-content"></div>
    </div>
    
    <div id="stats-topbottom" style="display:none; overflow-y:auto; padding:10px 0">
        <div id="topbottom-content"></div>
    </div>
    
    <div id="stats-gender" style="display:none; overflow-y:auto; padding:10px 0">
        <div id="gender-content"></div>
    </div>
    
    <div id="stats-orientation" style="display:none; overflow-y:auto; padding:10px 0">
        <div id="orientation-content"></div>
    </div>
</div>
    <div id="lycamMainPanel" class="card section" style="display:none; border-top:4px solid var(--lycam-color)">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
          <h3><i class="fa fa-clipboard-check" style="color:var(--lycam-color)"></i> Gestion LYCAM</h3>
          <button class="btn ghost close-panel"><i class="fa fa-arrow-left"></i> Retour</button>
        </div>
        
        <div class="tabs">
             <div class="tab active" onclick="switchLycamView('candidates')">Faire passer le test</div>
             <div class="tab" onclick="switchLycamView('results')">Consulter les résultats</div>
        </div>

        <div id="lycam-view-candidates" style="display:block; flex:1; overflow:hidden; display:flex; flex-direction:column;">
            <div class="toolbar" style="margin-top:0">
                <div class="field">
                    <label class="label">Filtrer par Classe</label>
                    <select id="lycam-class-filter" class="select" style="min-width:150px">
                        <option value="__ALL__">Toutes</option>
                    </select>
                </div>
                <div class="field" style="flex:1">
                    <label class="label">Rechercher un élève</label>
                    <input id="lycam-search-candidate" class="input" placeholder="Nom ou Matricule...">
                </div>
            </div>
            <div class="table-wrap" style="margin-top:12px;">
                <table id="lycam-candidates-table">
                    <thead><tr><th>Matricule</th><th>Nom & Prénoms</th><th>Classe</th><th>Statut</th><th>Action</th></tr></thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>

        <div id="lycam-view-results" style="display:none; flex:1; overflow:hidden; display:flex; flex-direction:column;">
             <div class="table-wrap">
                <table id="lycam-global-table">
                    <thead><tr><th>Identité</th><th>Total Risque</th><th>Détail des Dimensions (Score)</th><th>Date</th><th>Action</th></tr></thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
    </div>

    <div id="registryPanel" class="card section" style="display:none; border-top:4px solid var(--registry-color)">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
            <h3><i class="fa fa-address-book" style="color:var(--registry-color)"></i> Registre de Visites</h3>
            <button class="btn ghost close-panel"><i class="fa fa-arrow-left"></i> Retour</button>
        </div>
        
        <div class="toolbar" style="margin-top:0; margin-bottom:12px; align-items:flex-end">
            <div class="field" style="width:140px">
                <label class="label">Date & Heure</label>
                <input id="reg-datetime" type="datetime-local" class="input">
            </div>
            <div class="field" style="flex:1; min-width:200px">
                <label class="label">Nom (Élève/Parent)</label>
                <input id="reg-name" class="input" placeholder="Qui est venu ?">
            </div>
            <div class="field" style="width:120px">
                <label class="label">Type</label>
                <select id="reg-type" class="select">
                    <option>Parent</option>
                    <option>Élève</option>
                    <option>Autre</option>
                </select>
            </div>
            <div class="field" style="flex:1; min-width:200px">
                <label class="label">Contact / Email</label>
                <input id="reg-contact" class="input" placeholder="Téléphone ou Email">
            </div>
            <div class="field" style="flex:2; min-width:250px">
                <label class="label">Motif de la visite</label>
                <input id="reg-reason" class="input" placeholder="Ex: Convocation, Renseignement...">
            </div>
            <button id="btn-add-registry" class="btn registry-btn"><i class="fa fa-save"></i> Enregistrer</button>
        </div>

        <div class="table-wrap">
            <table id="registry-table">
                <thead>
                    <tr>
                        <th style="width:140px">Date / Heure</th>
                        <th style="width:100px">Type</th>
                        <th style="width:200px">Nom</th>
                        <th style="width:150px">Contact</th>
                        <th>Motif</th>
                        <th style="width:50px"></th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
    </div>

    <div id="trackingGlobalPanel" class="card section" style="display:none; border-top:4px solid var(--tracking-color)">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
            <h3><i class="fa fa-hands-helping" style="color:var(--tracking-color)"></i> Suivi & Coaching Global</h3>
            <button class="btn ghost close-panel"><i class="fa fa-arrow-left"></i> Retour</button>
        </div>

        <div class="tabs">
             <div class="tab active" onclick="switchTrackingView('visits')">Historique Suivi</div>
             <div class="tab" onclick="switchTrackingView('coaching')">Actions Coaching</div>
        </div>

        <div id="track-view-visits" style="display:block; flex:1; overflow:hidden; display:flex; flex-direction:column;">
             <div class="table-wrap">
                 <table id="track-visits-table">
                     <thead><tr><th>Date</th><th>Élève</th><th>Classe</th><th>Détails de l'échange</th></tr></thead>
                     <tbody></tbody>
                 </table>
             </div>
        </div>

        <div id="track-view-coaching" style="display:none; flex:1; overflow:hidden; display:flex; flex-direction:column;">
             <div class="table-wrap">
                 <table id="track-coaching-table">
                     <thead><tr><th>Date</th><th>Élève</th><th>Classe</th><th>Statut</th><th>Actions Entreprises</th></tr></thead>
                     <tbody></tbody>
                 </table>
             </div>
        </div>
    </div>

  </div>
</div>

<div id="modal-add-student" class="modal">
  <div class="modal-content">
    <div class="modal-body">
        <h3>Ajouter un élève</h3>
        <form id="form-add-student" style="display:flex;flex-direction:column;gap:12px">
        <div style="display:flex;gap:10px">
            <div class="field" style="flex:1"><label class="label">Matricule</label><input name="matricule" class="input" required></div>
            <div class="field" style="flex:1"><label class="label">Classe</label><input name="classe" class="input" placeholder="ex: 6e1"></div>
        </div>
        <div class="field"><label class="label">Nom</label><input name="nom" class="input" required></div>
        <div class="field"><label class="label">Prénoms</label><input name="prenoms" class="input"></div>
        <div style="display:flex;gap:10px">
            <div class="field" style="flex:1"><label class="label">Sexe</label><select name="sexe" class="select"><option value="M">Masculin</option><option value="F">Féminin</option></select></div>
            <div class="field" style="flex:1"><label class="label">Date Naiss.</label><input name="dateNaissance" type="date" class="input"></div>
        </div>
        </form>
    </div>
    <div class="modal-footer">
        <button type="button" id="btn-cancel-add" class="btn ghost">Annuler</button>
        <button type="button" id="btn-submit-add" class="btn">Enregistrer</button>
    </div>
  </div>
</div>

<div id="modal-lycam-test" class="modal">
    <div class="modal-content" style="max-width: 800px; max-height: 90vh;">
        <div style="padding:20px;border-bottom:1px solid var(--border);background:var(--surface-2);border-radius:16px 16px 0 0; position: sticky; top: 0; z-index: 10;">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <div>
                    <h3 style="margin:0">Test LYCAM</h3>
                    <div id="lycam-candidate-name" style="font-weight:bold;color:var(--lycam-color); margin-top: 4px;"></div>
                    <div style="font-size:12px;color:var(--text-muted); margin-top: 2px;">
                        <i class="fa fa-exclamation-circle"></i> Toutes les questions sont obligatoires
                    </div>
                </div>
                <div id="lycam-progress" style="background: var(--surface); padding: 8px 12px; border-radius: 20px; font-size: 12px; font-weight: bold; color: var(--lycam-color); border: 1px solid var(--border);">
                    0/41 répondues
                </div>
            </div>
            <!-- La div d'erreur sera ajoutée dynamiquement -->
        </div>
        
        <div class="modal-body" id="lycam-questions-container" style="padding: 20px; overflow-y: auto;">
            <!-- Les questions seront insérées ici -->
        </div>
        
        <div class="modal-footer" style="position: sticky; bottom: 0; background: var(--surface); border-top: 1px solid var(--border);">
            <button type="button" id="btn-cancel-lycam" class="btn ghost">
                <i class="fa fa-times"></i> Annuler
            </button>
            <button type="button" id="btn-submit-lycam" class="btn lycam-btn">
                <i class="fa fa-check-circle"></i> Valider le test
            </button>
        </div>
    </div>
</div>

<script>
// ====== LYCAM CONSTANTS & HELPERS ======
const LYCAM_QUESTIONS = [
  { "id": 1, "text": "D'une façon générale, est-ce que tu aimes ou non aller au lycée ?", "options": [ "A - Oui, j'aime ça", "B - J'aime ça plus ou moins", "C - Ça m'est égal", "D - Je n'aime pas ça", "E - J'en ai marre du lycée" ], "dimension": "IE" },
  { "id": 2, "text": "Tes parents rencontrent-ils les professeurs :", "options": [ "A - À l'occasion de réunions parents-professeurs", "B - En prenant rendez-vous avec un professeur", "C - S'ils sont convoqués", "D - Rarement parce qu'ils n'ont pas le temps", "E - Rarement parce qu'ils n'aiment pas venir au lycée" ], "dimension": "AF" },
  { "id": 3, "text": "Pourquoi fréquentes-tu le lycée ? (choisis une seule raison, la plus vraie dans ton cas)", "options": [ "A - Parce que j'aime ça", "B - Pour avoir un bon métier", "C - Comme ça, sans me poser de question", "D - Pour rencontrer des copains, des copines", "E - Parce que j'ai des projets précis", "F - Parce que j'y suis obligé(e)" ], "dimension": "IE" },
  { "id": 4, "text": "Depuis les trois dernières années, tes résultats scolaires sont-ils satisfaisants ?", "options": [ "A - Oui, très satisfaisants", "B - Satisfaisants", "C - Peu satisfaisants", "D - Pas du tout satisfaisants" ], "dimension": "RS" },
  { "id": 5, "text": "Pendant les cours écoutes-tu attentivement :", "options": [ "A - Cela dépend des jours", "B - Cela dépend des cours, de mon intérêt", "C - Oui, toujours", "D - Non, je me laisse facilement distraire" ], "dimension": "IE" },
  { "id": 6, "text": "Parmi les phrases suivantes, quelle est celle qui te représente le mieux ?", "options": [ "A - Je supporte très bien les règlements et les façons de faire du lycée", "B - Je supporte assez bien les règlements et le travail imposé par le lycée", "C - Je supporte difficilement les règlements et le travail imposé par le lycée", "D - Je ne supporte pas du tout les règlements et le travail imposé" ], "dimension": "IE" },
  { "id": 7, "text": "Avec le personnel du lycée (enseignants, surveillants, direction, infirmière, conseiller d'éducation, documentaliste...) tu penses que tes relations sont :", "options": [ "A - Très bonnes", "B - Bonnes", "C - Plus ou moins bonnes", "D - Mauvaises" ], "dimension": "BS" },
  { "id": 8, "text": "D'après les premières évaluations ou notes, tu penses que :", "options": [ "A - Ton année scolaire va bien se dérouler", "B - Ce sera trop difficile pour toi", "C - Tu y arriveras avec beaucoup de travail", "D - Quels que soient les résultats, cela t'est égal" ], "dimension": "RS" },
  { "id": 9, "text": "Quelle attitude as-tu devant un mauvais résultat ?", "options": [ "A - Ça m'est égal", "B - Ça me décourage un peu et j'ai du mal à m'en remettre", "C - Ça me décourage beaucoup et j'ai envie d'abandonner", "D - Je travaille plus pour me rattraper" ], "dimension": "CS" },
  { "id": 10, "text": "Tes parents, ta famille (...), parlent-ils avec toi du lycée ?", "options": [ "A - Souvent", "B - Quand il y a un évènement particulier", "C - Uniquement si c'est nécessaire (papiers administratifs, carnet de correspondance ...)", "D - Très rarely" ], "dimension": "AF" },
  { "id": 11, "text": "Selon toi, tes relations avec les professeurs sont :", "options": [ "A - Très bonnes", "B - Bonnes", "C - Plus ou moins bonnes", "D - Mauvaises" ], "dimension": "BS" },
  { "id": 12, "text": "Cette année, les cours :", "options": [ "A - T'intéressent tous", "B - T'intéressent pour la plupart", "C - Ne t'intéressent généralement pas", "D - Ne t'intéressent pas du tout" ], "dimension": "IE" },
  { "id": 13, "text": "Te sens-tu prêt(e) actuellement à quitter l'école pour aller travailler ?", "options": [ "A - Sûrement pas", "B - Pas encore", "C - Presque", "D - Tout à fait" ], "dimension": "PS" },
  { "id": 14, "text": "As-tu des résultats corrects ?", "options": [ "A - Non, je n'y arrive pas, même en travaillant", "B - Oui, en travaillant régulièrement", "C - Non, je n'ai pas envie de faire des efforts", "D - Oui, en étant attentif(ve) en classe" ], "dimension": "RS" },
  { "id": 15, "text": "Combien d'heures par semaines passes-tu à tes devoirs ou leçons ?", "options": [ "A - Plus de 10 heures /semaine", "B - De 6 à 10 heures / semaine", "C - De 2 à 5 heures / semaine", "D - Moins de 2 heures / semaine", "E - Aucune" ], "dimension": "RS" },
  { "id": 16, "text": "Je m'absente, mais je m'absenterais moins souvent si on me payait pour venir au lycée. Es-tu d'accord avec cette idée ?", "options": [ "A - Absolument pas d'accord", "B - Pas tout à fait d'accord", "C - Assez d'accord", "D - Je suis rarement absent(e)", "E - Tout à fait d'accord" ], "dimension": "AB" },
  { "id": 17, "text": "Jusqu'où penses-tu poursuivre tes études ?", "options": [ "A - Jusqu'à un diplôme (CAP-BEP-BAC...)", "B - Le plus loin possible", "C - Je pense que je n'irai pas plus loin que cette année", "D - Si j'avais eu le choix, j'aurais déjà quitté" ], "dimension": "PS" },
  { "id": 18, "text": "Ta famille souhaite que :", "options": [ "A - Tu obtiennes un diplôme (CAP-BEP-BAC...)", "B - Tu continues tes études le plus loin possible", "C - Tu gagnes ta vie le plus vite possible", "D - Je ne sais pas" ], "dimension": "AF" },
  { "id": 19, "text": "Est-ce que tu as déjà manqué des cours pour des raisons que le lycée ne trouve pas valables  (cette année ou l'année dernière) ?", "options": [ "A - Jamais", "B - Une ou deux fois", "C - Plusieurs fois", "D - Très souvent" ], "dimension": "AB" },
  { "id": 20, "text": "Si on te permettait d'abandonner le lycée dès maintenant, que ferais-tu ?", "options": [ "A - Je ne quitterais pas", "B - Je ne sais pas", "C - Je quitterais le lycée" ], "dimension": "PS" },
  { "id": 21, "text": "Pour ton travail scolaire, est-ce que ta famille (parents, sœurs, frères aînés...) ?", "options": [ "A - T'apporte une aide", "B - Contrôle ce que tu as fait", "C - Te fait confiance", "D - N'a pas le temps de s'en occuper", "E - Ne s'y intéresse pas" ], "dimension": "AF" },
  { "id": 22, "text": "As-tu l'intention de terminer les études que tu as commencées ?", "options": [ "A - Certainement", "B - Peut-être", "C - Pas du tout", "D - Je ne sais pas" ], "dimension": "PS" },
  { "id": 23, "text": "Dès que possible j'accepte n'importe quoi comme travail plutôt que de continuer à aller au lycée.", "options": [ "A - Oui", "B - Non" ], "dimension": "PS" },
  { "id": 24, "text": "Cette année, je pense que ça va aller pour moi à l'école.", "options": [ "A - Oui", "B - Non" ], "dimension": "CS" },
  { "id": 25, "text": "En général, je suis à peu près sûr(e) de réussir ce que je fais.", "options": [ "A - Oui", "B - Non" ], "dimension": "CS" },
  { "id": 26, "text": "J'ai obtenu l'orientation que je souhaitais.", "options": [ "A - Oui", "B - Non" ], "dimension": "PS" },
  { "id": 27, "text": "En général, j'aime le lycée.", "options": [ "A - Oui", "B - Non" ], "dimension": "IE" },
  { "id": 28, "text": "J'ai confiance en mes possibilités de réussite à l'école.", "options": [ "A - Oui", "B - Non" ], "dimension": "CS" },
  { "id": 29, "text": "Mes parents connaissent le nom de mon (ma) prof. principal(e).", "options": [ "A - Oui", "B - Non" ], "dimension": "AF" },
  { "id": 30, "text": "Quand j'ai des problèmes, la plupart de mes professeurs font des efforts pour me comprendre.", "options": [ "A - Oui", "B - Non" ], "dimension": "BS" },
  { "id": 31, "text": "Souvent, j'ai envie de \"sécher\" les cours.", "options": [ "A - Oui", "B - Non" ], "dimension": "AB" },
  { "id": 32, "text": "Si j'échoue cette année, je vais peut-être abandonner le lycée.", "options": [ "A - Oui", "B - Non" ], "dimension": "PS" },
  { "id": 33, "text": "La plupart de mes professeurs me donnent envie d'apprendre.", "options": [ "A - Oui", "B - Non" ], "dimension": "BS" },
  { "id": 34, "text": "En général, j'aime bien la façon dont mes professeurs font cours.", "options": [ "A - Oui", "B - Non" ], "dimension": "BS" },
  { "id": 35, "text": "J'aime m'absenter du lycée.", "options": [ "A - Oui", "B - Non" ], "dimension": "AB" },
  { "id": 36, "text": "Je préfèrerais avoir d'autres cours que ceux de cette année.", "options": [ "A - Oui", "B - Non" ], "dimension": "PS" },
  { "id": 37, "text": "Je risque d'échouer cette année au lycée.", "options": [ "A - Oui", "B - Non" ], "dimension": "RS" },
  { "id": 38, "text": "En général, mes professeurs essaient de me comprendre.", "options": [ "A - Oui", "B - Non" ], "dimension": "BS" },
  { "id": 39, "text": "Quand je suis absent(e) du lycée, j'ai une raison valable.", "options": [ "A - Oui", "B - Non" ], "dimension": "AB" },
  { "id": 40, "text": "Je réussis mieux dans ce que je fais en dehors du lycée que dans les matières scolaires.", "options": [ "A - Oui", "B - Non" ], "dimension": "CS" },
  { "id": 41, "text": "Je trouve désagréable d'aller en classe, que ce soit ici ou dans un autre lycée.", "options": [ "A - Oui", "B - Non" ], "dimension": "AB" }
];

const LYCAM_DIMENSIONS = {
  AF: { label: "Attitude de la famille", threshold: 2 },
  PS: { label: "Projet scolaire", threshold: 4 },
  RS: { label: "Rendement scolaire", threshold: 2 },
  CS: { label: "Confiance en soi", threshold: 3 },
  AB: { label: "Absentéisme", threshold: 2 },
  BS: { label: "Besoin de soutien", threshold: 3 },
  IE: { label: "Intérêt pour l'école", threshold: 2 }
};
const LYCAM_TOTAL_THRESHOLD = 18;

function getRiskScore(questionId, value) {
  const letter = value ? value.charAt(0) : '';
  const rules = {
      1:['D','E'], 2:['C','D','E'], 3:['C','F'], 4:['D','C'], 5:['D','A'],
      6:['D','C'], 7:['D','C'], 8:['D','B'], 9:['A','C'], 10:['D','C'],
      11:['D','C'], 12:['D','C'], 13:['D','C'], 14:['A','C'], 15:['D','E'],
      16:['C','E'], 17:['D','C'], 18:['D','C'], 19:['D','C'], 20:['B','C'],
      21:['D','E'], 22:['B'], 23:['A'], 24:['B'], 25:['B'], 26:['B'], 27:['B'],
      28:['B'], 29:['B'], 30:['B'], 31:['A'], 32:['A'], 33:['B'], 34:['B'],
      35:['A'], 36:['A'], 37:['A'], 38:['B'], 39:['B'], 40:['A'], 41:['A']
  };
  if(rules[questionId] && rules[questionId].includes(letter)) return 1;
  return 0;
}

/* ====== FONCTION DE GÉNÉRATION DE DONNÉES FICTIVES ====== */

/* ====== FONCTION DE GÉNÉRATION DE DONNÉES FICTIVES ====== */

function generateDummyData() {
    console.log("Génération des données fictives de démo...");

    // Noms et prénoms ivoiriens
    const dummyNames = [
        { nom: "KOUADIO", prenoms: "Jean-Paul", sexe: "M" },
        { nom: "KONAN", prenoms: "Aminata", sexe: "F" },
        { nom: "YEO", prenoms: "Sékou", sexe: "M" },
        { nom: "TRAORÉ", prenoms: "Fatou", sexe: "F" },
        { nom: "KOUASSI", prenoms: "Koffi", sexe: "M" },
        { nom: "DIAKITÉ", prenoms: "Mariam", sexe: "F" },
        { nom: "SORO", prenoms: "Yacouba", sexe: "M" },
        { nom: "DOSSO", prenoms: "Aïcha", sexe: "F" },
        { nom: "GNANGA", prenoms: "Bamba", sexe: "M" },
        { nom: "BAMBA", prenoms: "Kadidia", sexe: "F" },
        { nom: "KOUAKOU", prenoms: "Moussa", sexe: "M" },
        { nom: "FADIGA", prenoms: "Aminata", sexe: "F" },
        { nom: "COULIBALY", prenoms: "Issa", sexe: "M" },
        { nom: "DIABY", prenoms: "Fatim", sexe: "F" },
        { nom: "KOUADIO", prenoms: "Eric", sexe: "M" },
        { nom: "KOUAMÉ", prenoms: "N'Guessan", sexe: "M" },
        { nom: "KONE", prenoms: "Siaka", sexe: "M" },
        { nom: "DIBY", prenoms: "Mariam", sexe: "F" },
        { nom: "BÉDIÉ", prenoms: "Aya", sexe: "F" },
        { nom: "GBOHOU", prenoms: "Nadège", sexe: "F" },
        { nom: "KOUADIO", prenoms: "Yao", sexe: "M" },
        { nom: "OUATTARA", prenoms: "Rokia", sexe: "F" },
        { nom: "SANGARÉ", prenoms: "Mamadou", sexe: "M" },
        { nom: "KOUASSI", prenoms: "Akissi", sexe: "F" },
        { nom: "KOUADIO", prenoms: "N'Dri", sexe: "M" },
        { nom: "CAMARA", prenoms: "Sékouba", sexe: "M" },
        { nom: "KOUASSI", prenoms: "Affoué", sexe: "F" },
        { nom: "KOUAKOU", prenoms: "Kouamé", sexe: "M" },
        { nom: "BAMBA", prenoms: "Salimata", sexe: "F" },
        { nom: "KONE", prenoms: "Sita", sexe: "F" }
    ];
    
    // Classes typiques du système ivoirien
    const classes = ["6e A", "5e B", "4e C", "3e D", "2nde A", "1ère C", "Tle D"];
    
    // Fonction utilitaire pour générer des IDs simples
    const simpleID = (i) => `S${String(i+1).padStart(3, '0')}`;
    const randInt = (min, max) => Math.floor(Math.random() * (max - min + 1)) + min;
    const randFloat = (min, max) => (Math.random() * (max - min) + min).toFixed(2);
    
    // Générer des dates de naissance réalistes pour élèves ivoiriens (2006-2009 pour collège, 2003-2005 pour lycée)
    const generateBirthDate = (classe) => {
        if (classe.includes("6e") || classe.includes("5e")) {
            // 11-13 ans pour 6e-5e
            return `200${randInt(8, 9)}-${String(randInt(1, 12)).padStart(2, '0')}-${String(randInt(1, 28)).padStart(2, '0')}`;
        } else if (classe.includes("4e") || classe.includes("3e")) {
            // 14-16 ans pour 4e-3e
            return `200${randInt(6, 7)}-${String(randInt(1, 12)).padStart(2, '0')}-${String(randInt(1, 28)).padStart(2, '0')}`;
        } else {
            // 16-18 ans pour lycée
            return `200${randInt(4, 5)}-${String(randInt(1, 12)).padStart(2, '0')}-${String(randInt(1, 28)).padStart(2, '0')}`;
        }
    };
    
    // Remplir allStudents
    allStudents = dummyNames.map((data, i) => {
        const id = simpleID(i);
        const matricule = `MAT${2024000 + i}`; // Format avec année
        const classe = classes[i % classes.length];
        const dateNaissance = generateBirthDate(classe);
        
        // Générer des notes réalistes et variées selon le niveau
        let baseAvg;
        if (classe.includes("6e") || classe.includes("5e")) {
            baseAvg = parseFloat(randFloat(10, 15)); // Bonnes moyennes en début de collège
        } else if (classe.includes("4e") || classe.includes("3e")) {
            baseAvg = parseFloat(randFloat(8, 14)); // Moyennes plus variées
        } else {
            baseAvg = parseFloat(randFloat(7, 13)); // Lycée plus difficile
        }
        
        const mg_annuelle = baseAvg;
        const mg_1tr = parseFloat(randFloat(mg_annuelle - 3, mg_annuelle + 2));
        
        // Sujets selon le cycle
        let subjects = {};
        if (classe.includes("6e") || classe.includes("5e") || classe.includes("4e") || classe.includes("3e")) {
            // Collège
            subjects = {
                'maths': parseFloat(randFloat(baseAvg - 4, baseAvg + 4)),
                'francais': parseFloat(randFloat(baseAvg - 3, baseAvg + 3)),
                'anglais': parseFloat(randFloat(baseAvg - 2, baseAvg + 2)),
                'physique': parseFloat(randFloat(baseAvg - 3, baseAvg + 3)),
                'svt': parseFloat(randFloat(baseAvg - 2, baseAvg + 3)),
                'hg': parseFloat(randFloat(baseAvg - 1, baseAvg + 2)),
                'eps': parseFloat(randFloat(12, 18)), // EPS souvent élevée
                'art_plastique': parseFloat(randFloat(baseAvg, baseAvg + 3)),
                'conduite': parseFloat(randFloat(10, 16))
            };
        } else {
            // Lycée
            subjects = {
                'maths': parseFloat(randFloat(baseAvg - 5, baseAvg + 3)),
                'francais': parseFloat(randFloat(baseAvg - 3, baseAvg + 2)),
                'anglais': parseFloat(randFloat(baseAvg - 2, baseAvg + 2)),
                'physique': parseFloat(randFloat(baseAvg - 4, baseAvg + 2)),
                'svt': parseFloat(randFloat(baseAvg - 3, baseAvg + 3)),
                'hg': parseFloat(randFloat(baseAvg - 2, baseAvg + 2)),
                'eps': parseFloat(randFloat(11, 17)),
                'philosophie': parseFloat(randFloat(baseAvg - 2, baseAvg + 3)),
                'lv2': parseFloat(randFloat(baseAvg - 1, baseAvg + 1))
            };
        }
        
        return {
            id: id,
            matricule: matricule,
            nom: data.nom,
            prenoms: data.prenoms,
            sexe: data.sexe,
            dateNaissance: dateNaissance,
            classe: classe,
            moyennes: {
                '1TR': {
                    'Moy_generale': mg_1tr,
                    ...Object.keys(subjects).reduce((acc, sub) => {
                        acc[sub] = parseFloat(randFloat(subjects[sub] - 2, subjects[sub] + 2));
                        return acc;
                    }, {})
                },
                '2TR': {
                    'Moy_generale': parseFloat(randFloat(mg_annuelle - 1, mg_annuelle + 1)),
                    ...Object.keys(subjects).reduce((acc, sub) => {
                        acc[sub] = parseFloat(randFloat(subjects[sub] - 1.5, subjects[sub] + 1.5));
                        return acc;
                    }, {})
                },
                '3TR': {
                    'Moy_generale': parseFloat(randFloat(mg_annuelle - 0.5, mg_annuelle + 0.5)),
                    ...Object.keys(subjects).reduce((acc, sub) => {
                        acc[sub] = parseFloat(randFloat(subjects[sub] - 1, subjects[sub] + 1));
                        return acc;
                    }, {})
                },
                'Annuelle': {
                    'Moy_generale': mg_annuelle,
                    ...subjects
                }
            },
            rangs: {
                '1TR': randInt(1, 30),
                '2TR': randInt(1, 30),
                '3TR': randInt(1, 30),
                'Annuelle': randInt(1, 30)
            }
        };
    });
    
    // Remplir allTestResults (LYCAM)
    allTestResults = [];
    allStudents.forEach((s, i) => {
        // 60% des élèves ont passé le test (plus réaliste)
        if (Math.random() < 0.6) {
            const score = randInt(8, 25); // Score total entre 8 et 25
            const isHighRisk = score >= LYCAM_TOTAL_THRESHOLD;
            
            // Générer des scores de dimensions réalistes
            const dimScores = {};
            Object.keys(LYCAM_DIMENSIONS).forEach(dim => {
                // Certaines dimensions ont plus de risques selon le profil
                if (s.moyennes['Annuelle']?.Moy_generale < 10) {
                    // Élèves en difficulté scolaire
                    dimScores[dim] = randInt(1, 4);
                } else if (s.sexe === 'F' && ['RS', 'CS'].includes(dim)) {
                    // Filles souvent meilleures en confiance et rendement
                    dimScores[dim] = randInt(0, 2);
                } else {
                    dimScores[dim] = randInt(0, 3);
                }
            });
            
            allTestResults.push({
                id: uuid(),
                matricule: s.matricule,
                at: new Date(Date.now() - randInt(1, 60) * 24 * 60 * 60 * 1000).toISOString(),
                totalScore: score,
                dimensionScores: dimScores,
                riskDimensions: Object.keys(dimScores).filter(dim => 
                    dimScores[dim] >= LYCAM_DIMENSIONS[dim].threshold
                ).map(dim => LYCAM_DIMENSIONS[dim].label)
            });
            
            // Ajouter un suivi pour les élèves à haut risque
            if (isHighRisk) {
                coachingData.push({ 
                    id: uuid(), 
                    matricule: s.matricule, 
                    at: new Date(Date.now() - randInt(1, 15) * 24 * 60 * 60 * 1000).toISOString(), 
                    status: Math.random() > 0.7 ? 'Terminé' : 'En cours', 
                    actions: `Plan d'action suite au score LYCAM élevé (${score}). Rencontre parentale programmée.`
                });
            }
            
            // Ajouter quelques visites de suivi
            if (Math.random() < 0.4) {
                allVisits.push({
                    id: uuid(),
                    matricule: s.matricule,
                    at: new Date(Date.now() - randInt(1, 45) * 24 * 60 * 60 * 1000).toISOString(),
                    details: Math.random() > 0.5 
                        ? "Discussion sur les résultats du 1er trimestre" 
                        : "Échange sur le comportement en classe"
                });
            }
        }
    });

    // Ajouter quelques entrées au registre
    const parentNames = ["KOUADIO", "TRAORÉ", "KONE", "DIABY", "SORO", "CAMARA", "BAMBA", "GBOHOU"];
    for (let i = 0; i < 8; i++) {
        allRegistry.push({
            id: uuid(),
            at: new Date(Date.now() - randInt(1, 30) * 24 * 60 * 60 * 1000).toISOString(),
            name: parentNames[i] + " " + (Math.random() > 0.5 ? "Moussa" : "Mariam"),
            type: Math.random() > 0.3 ? "Parent" : "Élève",
            contact: `+225 07${randInt(10, 99)} ${randInt(1000, 9999)} ${randInt(1000, 9999)}`,
            reason: Math.random() > 0.5 ? "Convocation discipline" : "Renseignement orientation"
        });
    }

    // Sauvegarde en local storage
    const currentYear = getSelectedYear();
    studentsStore.save(currentYear, allStudents);
    storage.save('LYCAMTestResults', allTestResults);
    storage.save('studentVisits', allVisits);
    storage.save('LYCAMCoachingData', coachingData);
    storage.save('GlobalRegistryData', allRegistry);

    console.log(`Données fictives générées : ${allStudents.length} élèves, ${allTestResults.length} résultats LYCAM, ${allVisits.length} visites.`);
    
    // Recharger l'affichage
    loadStudentsForYear();
    renderRegistry();
    setStatus(`Données de démo générées (${allStudents.length} élèves)`, 'success');
}

/* CONFIG & DICTIONARY */
const CONFIG = { dbName: 'kfwDB', dbVersion: 3 };
const DICTIONARY = {
  nom_complet: ['nom et prenoms','nom & prenoms','nom_prenom','nom complet','noms et prenoms','noms & prenoms','nom et prenom','nom & prenom','nom prenom','nom_et_prenoms','nom/prenom','full name','fullname'],
  matricule: ['matricule','mat','mat.','id','code','num'],
  nom: ['nom','noms','surname','familyname','name'],
  prenoms: ['prenom','prenoms','firstname','pren'],
  sexe: ['sexe','genre','sex'],
  dateNaissance: ['date de naissance','date_naissance','datenaissance','ddn','né le','ne le','ne(e) le','né(e) le','naissance','dob','date n','date.n'],
  classe: ['classe','class','groupe','niv'],
  maths: ['math','maths','mathematique','ml'],
  francais: ['fr','fra','francais','français','frs'],
  anglais: ['anglais'],
  physique: ['pc','sp','phys','physique'],
  svt: ['svt','bio','biologie','sciences'],
  hg: ['hg','hist','geo','histoire'],
  eps: ['eps','sport','education physique'],
  philosophie: ['philo','philosophie'],
  lv2: ['lv2','espagnol','allemand','esp','all'],
  art_plastique: ['ap','art','arts','dessin'],
  conduite: ['conduite','cond','comportement'],
  moyenne: ['moy','moyenne','mg','gen','generale'],
  rang: ['rg','rang','rank']
};

function normalizeStr(str) {
  if (!str) return '';
  return String(str).toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "").replace(/[^a-z0-9]/g, ""); 
}
function findColumnValue(row, targetKey, exclusions = []) {
  const possibleKeys = DICTIONARY[targetKey] || [targetKey];
  for (let rk of Object.keys(row)) {
    const cleanHeader = normalizeStr(rk);
    if (exclusions.some(exc => cleanHeader.includes(normalizeStr(exc)))) continue;
    for (let alias of possibleKeys) {
      if (cleanHeader.includes(normalizeStr(alias))) return row[rk];
    }
  }
  return undefined;
}

let allStudents = [];
let allTestResults = []; 
let allVisits = [];      
let coachingData = [];   
let allRegistry = []; 
let currentStudent = null;
let currentLycamCandidate = null;

function getSelectedYear(){ return document.getElementById('school-year').value; }
function h(x){ return (x==null)?'':String(x); }
function fmtDate(d){ if(!d)return'—'; const t=(typeof d==='number')?new Date((d-(25567+2))*86400*1000):new Date(d); return isNaN(t)?String(d):t.toLocaleDateString('fr-FR'); }
function fmtDateTime(d){ if(!d)return'—'; const t = new Date(d); return isNaN(t)?String(d): t.toLocaleString('fr-FR', {dateStyle:'short', timeStyle:'short'}); }
function uuid(){ return 'id-'+Math.random().toString(36).slice(2); }
function normalizeClasseKey(s){ return normalizeStr(s).replace('eme','e'); }
function setStatus(msg, type = 'info') {
  const statusEl = document.getElementById('status');
  const icons = {
    info: 'fa-info-circle',
    success: 'fa-check-circle',
    warning: 'fa-exclamation-triangle',
    error: 'fa-times-circle',
    loading: 'fa-spinner fa-spin'
  };
  const colors = {
    info: 'var(--brand)',
    success: 'var(--accent)',
    warning: 'var(--warn)',
    error: 'var(--danger)',
    loading: 'var(--brand)'
  };
  
  statusEl.innerHTML = `<i class="fa ${icons[type]}" style="color:${colors[type]}"></i> ${msg}`;
}
/* DB STORAGE */
const idb = {
  db: null,
  async open() {
    if (this.db) return this.db;
    return new Promise((resolve, reject) => {
      const req = indexedDB.open(CONFIG.dbName, CONFIG.dbVersion);
      req.onupgradeneeded = (e) => { const db = e.target.result; if (!db.objectStoreNames.contains('studentsByYear')) db.createObjectStore('studentsByYear'); };
      req.onsuccess = (e) => { this.db = e.target.result; resolve(this.db); };
      req.onerror = (e) => reject(e);
    });
  },
  async put(storeName, key, value) {
    const db = await this.open();
    return new Promise((resolve, reject) => {
      const tx = db.transaction(storeName, 'readwrite');
      tx.objectStore(storeName).put(value, key);
      tx.oncomplete = () => resolve();
      tx.onerror = reject;
    });
  },
  async get(storeName, key) {
    const db = await this.open();
    return new Promise((resolve, reject) => {
      const tx = db.transaction(storeName, 'readonly');
      const req = tx.objectStore(storeName).get(key);
      req.onsuccess = () => resolve(req.result);
      req.onerror = reject;
    });
  },
  async listKeys(storeName) {
    const db = await this.open();
    return new Promise((resolve, reject) => {
      const tx = db.transaction(storeName, 'readonly');
      const req = tx.objectStore(storeName).getAllKeys();
      req.onsuccess = () => resolve(req.result);
      req.onerror = reject;
    });
  }
};
const studentsStore = {
  save: async (year, data) => idb.put('studentsByYear', year, data),
  load: async (year) => (await idb.get('studentsByYear', year)) || [],
  listYears: async () => idb.listKeys('studentsByYear')
};
const storage = {
  load(key, fallback){ try{ return JSON.parse(localStorage.getItem(key)) ?? fallback; } catch{ return fallback; } },
  save(key, value){ localStorage.setItem(key, JSON.stringify(value)); }
};

/* LOGIQUE */
async function loadGlobalData() {
  allTestResults = storage.load('LYCAMTestResults', []);
  allVisits = storage.load('studentVisits', []);
  coachingData = storage.load('LYCAMCoachingData', []);
  allRegistry = storage.load('GlobalRegistryData', []);
}

async function loadStudentsForYear(){
  const year = getSelectedYear();
  setStatus('Chargement...', 'loading');
  allStudents = await studentsStore.load(year);
  allStudents.forEach(s => { if(!s.id) s.id = s.matricule || uuid(); });
  populateClassFilter();
  renderRoster();
  setStatus(`${allStudents.length} élèves`, 'success');
}

function populateClassFilter(){
  const sel = document.getElementById('class-filter');
  const selLycam = document.getElementById('lycam-class-filter'); 
  
  const oldVal = sel.value;
  const classes = [...new Set(allStudents.map(s => s.classe).filter(Boolean))].sort();
  
  sel.innerHTML = '<option value="__ALL__">Toutes les classes</option>';
  selLycam.innerHTML = '<option value="__ALL__">Toutes les classes</option>';
  
  classes.forEach(c => {
      sel.add(new Option(c, normalizeClasseKey(c)));
      selLycam.add(new Option(c, normalizeClasseKey(c)));
  });
  
  if(oldVal && oldVal !== '__ALL__') for(let opt of sel.options){ if(opt.value === oldVal) sel.value = oldVal; }
}

// --- HELPER LYCAM ---
function getLycamRiskInfo(score) {
    const isHighRisk = score >= LYCAM_TOTAL_THRESHOLD;
    return {
        label: isHighRisk ? "RISQUE ÉLEVÉ" : "FAIBLE RISQUE",
        // Rouge pour élevé, Vert pour faible
        color: isHighRisk ? "#dc2626" : "#16a34a", 
        bg: isHighRisk ? "#fee2e2" : "#dcfce7",
        border: isHighRisk ? "#fecaca" : "#bbf7d0",
        icon: isHighRisk ? "fa-exclamation-circle" : "fa-shield-alt"
    };
}

function renderRoster(list) {
  const sel = document.getElementById('class-filter');
  const filterKey = sel.value;
  let rows = list || allStudents;
  if(!list && filterKey !== '__ALL__') rows = allStudents.filter(s => normalizeClasseKey(s.classe) === filterKey);

  // OPTIMISATION : Créer une Map des derniers résultats LYCAM pour accès instantané
  const lycamMap = new Map();
  allTestResults.forEach(t => {
      // On garde le résultat le plus récent pour chaque matricule
      if(!lycamMap.has(t.matricule) || t.at > lycamMap.get(t.matricule).at) {
          lycamMap.set(t.matricule, t);
      }
  });

  const tbody = document.querySelector('#roster tbody');
  tbody.innerHTML = '';
  
  rows.forEach(s => { 
    // Récupération optimisée du résultat
    const test = lycamMap.get(s.matricule);
    let lycamBadge = '';
    
    if(test) {
        const score = test.totalScore !== undefined ? test.totalScore : (test.total || 0);
        const info = getLycamRiskInfo(score);
        // Badge joli et optimisé
        lycamBadge = `<span class="badge" style="background:${info.bg}; color:${info.color}; border:1px solid ${info.border}; font-size:10px; margin-left:8px; padding:2px 8px;">
            <i class="fa ${info.icon}"></i> ${info.label}
        </span>`;
    }

    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${h(s.matricule)}</td>
      <td style="display:flex;align-items:center">
         <div>
            <span class="name-part">${h(s.nom)}</span> ${h(s.prenoms||s.prenom)}
         </div>
         ${lycamBadge}
      </td>
      <td><span class="badge" style="background:var(--brand-light);color:var(--brand-dark)">${h(s.classe)}</span></td>
      <td style="text-align:center">${h(s.sexe)}</td>
      <td style="text-align:center;font-size:12px">${fmtDate(s.dateNaissance)}</td>
      <td style="text-align:center"><button class="btn ghost btn-view" style="padding:2px 6px;font-size:11px"><i class="fa fa-eye"></i></button></td>
    `;
    tr.onclick = (e) => { openStudent(s); };
    tbody.appendChild(tr);
  });
  
  const male = rows.filter(s => (s.sexe||'').startsWith('M')).length;
  const female = rows.length - male;
  document.getElementById('class-stats').innerHTML = `<i class="fa fa-users"></i> ${rows.length} <span style="opacity:0.5">|</span> <i class="fa fa-female"></i> ${female} <i class="fa fa-male"></i> ${male}`;
}

async function openStudent(s){
  currentStudent = s;
  document.querySelectorAll('.section').forEach(p => p.style.display = 'none');
  document.getElementById('studentPanel').style.display = 'block';
  
  document.getElementById('st-name').textContent = `${s.nom} ${s.prenoms||s.prenom}`;
  document.getElementById('st-mat').textContent = s.matricule;
  document.getElementById('st-class').textContent = s.classe;
  document.getElementById('st-sex').textContent = s.sexe;
  document.getElementById('st-born').textContent = fmtDate(s.dateNaissance);
  await renderGrades(s);
  renderVisits(s);
  renderCoachings(s);
  renderKPIs(s);
  window.scrollTo({top:0, behavior:'smooth'});
}

function leaveDetailMode(){
  document.querySelectorAll('.section').forEach(s => {
      if(s.id !== 'rosterPanel') s.style.display = 'none';
  });
  document.getElementById('rosterPanel').style.display = 'flex';
  document.getElementById('rosterPanel').style.flexDirection = 'column';
  currentStudent = null;
  renderRoster(); 
}

/* --- EXCEL IMPORT --- */
async function handleExcel(file){
  try {
    setStatus('Importation en cours...', 'loading');
    const data = await file.arrayBuffer();
    const wb = XLSX.read(data, {type:'array'});
    const sheetName = wb.SheetNames.find(n => n.match(/effectif|liste|eleve|base/i)) || wb.SheetNames[0];
    const raw = XLSX.utils.sheet_to_json(wb.Sheets[sheetName], {defval:''});
    
    if(raw.length === 0) throw new Error("Fichier vide");

    // Initialiser le tableau students
    let students = [];

    raw.forEach(r => {
      let valNomComplet = findColumnValue(r, 'nom_complet');
      let valNom = findColumnValue(r, 'nom', ['prenom']); 
      let valPrenom = findColumnValue(r, 'prenoms', ['nom']); 
      let nomFinal = '';
      let prenomFinal = '';

      if (valNomComplet) {
         const parts = String(valNomComplet).trim().split(/\s+/);
         nomFinal = parts.shift(); 
         prenomFinal = parts.join(' '); 
      } else if (valNom) {
         if (!valPrenom || String(valPrenom).trim() === '') {
             const parts = String(valNom).trim().split(/\s+/);
             nomFinal = parts.shift();
             prenomFinal = parts.join(' ');
         } else {
             nomFinal = valNom;
             prenomFinal = valPrenom;
         }
      }

      let matricule = findColumnValue(r, 'matricule');
      if (!matricule && !nomFinal) return;

      const student = {
        id: uuid(),
        matricule: String(matricule || 'Inconnu').trim(),
        nom: String(nomFinal || '').trim(),
        prenoms: String(prenomFinal || '').trim(),
        sexe: findColumnValue(r, 'sexe') || '',
        dateNaissance: findColumnValue(r, 'dateNaissance') || '',
        classe: findColumnValue(r, 'classe') || '',
        moyennes: { 'Annuelle': {}, '1TR': {}, '2TR': {}, '3TR': {} },
        rangs: { 'Annuelle': '', '1TR': '', '2TR': '', '3TR': '' }
      };
      
      // Ajouter l'élève au tableau
      students.push(student);
    });

    // Filtrer les étudiants valides
    students = students.filter(s => s !== null && s.nom !== '');

    // Fonction pour parser les notes
// Fonction pour parser les notes - VERSION CORRIGÉE
const parseGrades = (pattern, key) => {
  const shName = wb.SheetNames.find(n => n.match(pattern));
  if(!shName) return;
  const rows = XLSX.utils.sheet_to_json(wb.Sheets[shName], {defval:''});
  
  console.log(`Parsing ${key} from sheet: ${shName}`);
  
  rows.forEach((row, index) => {
    const mat = String(findColumnValue(row, 'matricule') || '').trim();
    const st = students.find(s => s.matricule === mat);
    
    if(st) {
      // 1. D'abord traiter le rang (pour éviter les conflits)
      const rg = findColumnValue(row, 'rang');
      if(rg) st.rangs[key] = rg;
      
      // 2. Traiter la moyenne générale
      const mg = findColumnValue(row, 'moyenne'); 
      if(mg) {
        const mgVal = parseFloat(mg);
        if(!isNaN(mgVal)) st.moyennes[key]['Moy_generale'] = mgVal;
      }
      
      // 3. Traiter les matières - APPROCHE PLUS PRÉCISE
      const subjectColumns = {
        'francais': ['fr','fra','francais','français','frs'],
        'maths': ['math','maths','mathematique','ml'],
        'anglais': ['anglais','eng','english'],
        'physique': ['pc','sp','phys','physique'],
        'svt': ['svt','bio','biologie','sciences'],
        'hg': ['hg','hist','geo','histoire','géographie'],
        'eps': ['eps','sport','education physique'],
        'philosophie': ['philo','philosophie'],
        'lv2': ['lv2','espagnol','allemand','esp','all'],
        'art_plastique': ['ap','art','arts','dessin'],
        'conduite': ['conduite','cond','comportement']
      };
      
      Object.keys(row).forEach(colRaw => {
        const colClean = normalizeStr(colRaw);
        const val = parseFloat(row[colRaw]);
        
        if(!isNaN(val)) {
          // Vérifier d'abord que ce n'est pas une colonne de rang
          if(colClean.includes('rang') || colClean.includes('rg') || colClean.includes('rank')) {
            return; // Ignorer, c'est déjà traité
          }
          
          // Chercher la matière correspondante
          for(const [subject, aliases] of Object.entries(subjectColumns)) {
            if(aliases.some(alias => colClean === normalizeStr(alias) || colClean.includes(normalizeStr(alias)))) {
              st.moyennes[key][subject] = val;
              break; // Sortir de la boucle une fois trouvé
            }
          }
        }
      });
    }
  });
};

    // Parser les notes pour chaque période
    parseGrades(/1.*(TR|Trim)/i, '1TR');
    parseGrades(/2.*(TR|Trim)/i, '2TR');
    parseGrades(/3.*(TR|Trim)/i, '3TR');
    parseGrades(/Ann|Synthese|Global/i, 'Annuelle');

    // Sauvegarder et recharger
    await studentsStore.save(getSelectedYear(), students);
    await loadStudentsForYear();
    setStatus(`${students.length} élèves importés`, 'success');
    alert(`${students.length} élèves importés avec succès.`);
  } catch(e) {
    console.error("Erreur d'importation:", e);
    setStatus('Erreur d\'importation', 'error');
    alert("Erreur lors de l'importation : " + e.message);
  }
}

function getSubjectDisplayName(k){
  const names = {'maths':'Maths', 'francais':'Français', 'anglais':'Anglais', 'physique':'Physique', 'svt':'SVT', 'hg':'Hist-Géo', 'eps':'EPS', 'philosophie':'Philo', 'lv2':'LV2', 'conduite':'Conduite', 'art_plastique':'Arts'};
  return names[k] || k.charAt(0).toUpperCase() + k.slice(1);
}
function getSubjectsOrder(cls){
  const c = (cls||'').toLowerCase();
  if(c.match(/^(6|5|4|3)/)) return ['francais','maths','anglais','physique','svt','hg','eps','art_plastique','conduite'];
  return ['francais','maths','anglais','hg','svt','physique','eps'];
}
function getStudentNote(s, period, subjectKey) {
  const m = s.moyennes[period];
  if (!m) return -1;
  if (m[subjectKey] !== undefined) return m[subjectKey];
  return -1;
}

function renderRankingsToContainer(containerId) {
    const container = document.getElementById(containerId);
    const scope = document.getElementById('rank-scope').value;
    const classKey = document.getElementById('rank-class-filter').value;
    const subjFilter = document.getElementById('subject-filter').value;
    
    // MODIFICATION 1 : Cartes beaucoup plus larges (550px min au lieu de 400px)
    container.style.gridTemplateColumns = "repeat(auto-fill, minmax(550px, 1fr))";

    const students = allStudents.filter(s => normalizeClasseKey(s.classe) === normalizeClasseKey(classKey));
    if(students.length === 0) { container.innerHTML = '<div style="padding:20px;text-align:center">Aucun élève.</div>'; return; }
    
    let subjects = [subjFilter]; 
    let html = '';
    
    subjects.forEach(sub => {
        // Calculer la moyenne de classe pour cette matière
        const classAverage = calculateClassAverage(students, sub, scope);
        const avgColor = classAverage >= 10 ? 'var(--accent)' : 'var(--danger)';
        
        let ranking = students.map(s => { 
            return { s: s, val: getStudentNote(s, scope, sub) }; 
        }).filter(x => x.val != null && !isNaN(x.val) && x.val >= 0);
        
        if(ranking.length === 0) return;
        ranking.sort((a,b) => b.val - a.val);
        
        html += `<div class="card" style="padding:0;overflow:hidden">
                <div style="background:var(--brand-light);padding:12px;font-weight:700;display:flex;justify-content:space-between;align-items:center;color:var(--brand-dark);font-size:14px">
                    <span>${getSubjectDisplayName(sub)}</span>
                    <span style="background:white;padding:2px 10px;border-radius:12px;font-size:12px;color:${avgColor};border:1px solid var(--border)">
                        Moy.classe: ${classAverage ? classAverage.toFixed(2) : '—'}
                    </span>
                </div>
                <div class="table-wrap" style="max-height:600px;border:none">
                <table><tbody>`;
        
        ranking.forEach((item, i) => {
            let style = (i<3)?'font-weight:bold;background:#fffbeb':'';
            
            // MODIFICATION 3 : Ajout de l'événement onclick et du curseur pointer
            // On utilise l'ID pour retrouver l'objet élève de manière sûre
            html += `<tr style="${style}; cursor:pointer" onclick="openStudent(allStudents.find(s => s.id === '${item.s.id}'))">
               <td style="width:40px; padding:10px 8px">#${i+1}</td>
               <td style="padding:10px 8px"><span class="name-part" style="font-size:13px">${h(item.s.nom)}</span> ${h(item.s.prenoms)}</td>
               <td style="text-align:right;font-weight:bold;font-size:14px;padding:10px 12px">${item.val.toFixed(2)}</td>
            </tr>`;
        });
        html += `</tbody></table></div></div>`;
    });
    container.innerHTML = html || '<div style="text-align:center">Pas de données.</div>';
}

// CORRECTION: Better logic for trends
async function renderGrades(s){
  const tbody = document.querySelector('#grades-table tbody');
  const thead = document.querySelector('#grades-table thead tr');
  
  // Clean headers (visual check)
  if(!thead.innerHTML.includes('Matière')) thead.innerHTML = `<th>Matière</th><th>1TR</th><th>2TR</th><th>3TR</th><th>Annuelle</th>`;
  
  tbody.innerHTML = '';
  
  // 1. Calculate prev year
  const currentYearStr = getSelectedYear(); 
  const parts = currentYearStr.split('-');
  let prevYearStr = null;
  if(parts.length === 2) {
      const y1 = parseInt(parts[0]);
      const y2 = parseInt(parts[1]);
      if(!isNaN(y1) && !isNaN(y2)) prevYearStr = `${y1-1}-${y2-1}`;
  }

  // 2. Fetch prev student
  let prevStudent = null;
  let hasPrevYearData = false;
  if(prevYearStr) {
      try {
          const prevData = await studentsStore.load(prevYearStr);
          if(prevData && prevData.length > 0) {
              hasPrevYearData = true;
              prevStudent = prevData.find(ps => ps.matricule === s.matricule);
          }
      } catch(e) { console.log("Pas de données N-1"); }
  }
  
  // Add warning icon to title if previous data is missing
  const gradeTab = document.querySelector('.tab[data-tab="grades"]');
  if(!hasPrevYearData && prevYearStr) {
      gradeTab.innerHTML = 'Moyennes <i class="fa fa-exclamation-triangle" style="color:var(--warn);font-size:10px" title="Importez l\'année ' + prevYearStr + ' pour voir les variations"></i>';
  } else {
      gradeTab.innerHTML = 'Moyennes';
  }

  // 3. Helper to generate trend arrow
  const getTrendHTML = (currVal, period, subjectKey) => {
      // Must have previous student data
      if(!prevStudent) return ''; 
      
      const prevVal = getStudentNote(prevStudent, period, subjectKey);
      
      // If previous value is missing (-1 or undefined), no arrow
      if(prevVal === undefined || prevVal < 0) return '';

      let icon = '', color = '';
      if(currVal > prevVal) { icon='fa-arrow-up'; color='var(--accent)'; }
      else if(currVal < prevVal) { icon='fa-arrow-down'; color='var(--danger)'; }
      else return '<span style="color:#cbd5e1;font-size:10px;margin-left:5px">=</span>'; 

      return `<i class="fa ${icon}" style="color:${color};font-size:11px;margin-left:6px;cursor:help;display:inline-block" title="Année ${prevYearStr}: ${prevVal.toFixed(2)}"></i>`;
  };

  getSubjectsOrder(s.classe).forEach(sub => {
    const g = (p) => { 
        let v = getStudentNote(s, p, sub); 
        if(v < 0) return '—';
        return `<span>${v.toFixed(2)}</span>` + getTrendHTML(v, p, sub); 
    };
    tbody.innerHTML += `<tr><td>${getSubjectDisplayName(sub)}</td><td>${g('1TR')}</td><td>${g('2TR')}</td><td>${g('3TR')}</td><td>${g('Annuelle')}</td></tr>`;
  });

  const getM = (p) => { 
      const v = s.moyennes[p]?.Moy_generale; 
      if(!v) return '—';
      // Manual trend for general average
      let trend = '';
      if(prevStudent && prevStudent.moyennes[p]?.Moy_generale) {
          const pv = prevStudent.moyennes[p].Moy_generale;
          if(v > pv) trend = `<i class="fa fa-arrow-up" style="color:var(--accent);font-size:11px;margin-left:6px;cursor:help;display:inline-block" title="Année ${prevYearStr}: ${pv.toFixed(2)}"></i>`;
          else if(v < pv) trend = `<i class="fa fa-arrow-down" style="color:var(--danger);font-size:11px;margin-left:6px;cursor:help;display:inline-block" title="Année ${prevYearStr}: ${pv.toFixed(2)}"></i>`;
          else trend = '<span style="color:#cbd5e1;font-size:10px;margin-left:5px">=</span>';
      }
      return `<b>${v.toFixed(2)}</b>` + trend;
  };

  tbody.innerHTML += `<tr style="font-weight:bold;background:var(--surface-2)"><td>MOYENNE GEN.</td><td>${getM('1TR')}</td><td>${getM('2TR')}</td><td>${getM('3TR')}</td><td>${getM('Annuelle')}</td></tr>`;
  
  const getR = (p) => { const v = s.rangs?.[p]; return v ? v : '-'; };
  tbody.innerHTML += `<tr style="font-weight:bold;color:var(--brand-dark)"><td>RANG</td><td>${getR('1TR')}</td><td>${getR('2TR')}</td><td>${getR('3TR')}</td><td>${getR('Annuelle')}</td></tr>`;
}

function renderKPIs(s){
  const anns = s.moyennes['Annuelle']?.Moy_generale;
  document.getElementById('kpi-avg').innerHTML = `1TR: <b>${s.moyennes['1TR']?.Moy_generale?.toFixed(2)||'—'}</b> • 2TR: <b>${s.moyennes['2TR']?.Moy_generale?.toFixed(2)||'—'}</b> • 3TR: <b>${s.moyennes['3TR']?.Moy_generale?.toFixed(2)||'—'}</b><br><br><span style="font-size:1.3em;color:var(--brand)">Annuelle: ${anns?.toFixed(2)||'—'}</span>`;
  document.getElementById('kpi-status').textContent = (anns >= 10) ? 'Admis' : 'Refusé';
  document.getElementById('kpi-status').className = (anns >= 10) ? 'badge' : 'badge';
  document.getElementById('kpi-status').style.background = (anns >= 10) ? '#dcfce7' : '#fee2e2';
  document.getElementById('kpi-status').style.color = (anns >= 10) ? '#16a34a' : '#dc2626';
}

/* ====== LYCAM LOGIC ====== */
function deleteLycam(id){ 
    if(confirm('Supprimer ce résultat ?')){ 
        allTestResults = allTestResults.filter(t => t.id !== id); 
        storage.save('LYCAMTestResults', allTestResults); 
        renderLycamGlobal();
    } 
}

function startLycamTest(student) {
    if(!student) return;
    currentLycamCandidate = student;
    const container = document.getElementById('lycam-questions-container');
    container.innerHTML = '';
    document.getElementById('lycam-candidate-name').textContent = `${student.nom} ${student.prenoms}`;
    
    // Réinitialiser le message d'erreur
    const errorDiv = document.getElementById('lycam-error-message');
    if (errorDiv) errorDiv.style.display = 'none';
    
    LYCAM_QUESTIONS.forEach(q => {
        const block = document.createElement('div');
        block.className = 'question-block';
        block.id = `q-block-${q.id}`;
        // Ajouter un astérisque pour indiquer que c'est obligatoire
        let html = `<div class="question-text">${q.id}. ${q.text}<span class="required-asterisk">*</span></div>`;
        q.options.forEach(opt => {
            html += `<label class="option-label"><input type="radio" name="q_${q.id}" value="${opt}" data-qid="${q.id}"> ${opt}</label>`;
        });
        block.innerHTML = html;
        container.appendChild(block);
    });
    
    // Ajouter un écouteur pour retirer le style "missing" quand une réponse est sélectionnée
    container.addEventListener('change', function(e) {
        if (e.target.type === 'radio') {
            const questionId = e.target.getAttribute('data-qid');
            const questionBlock = document.getElementById(`q-block-${questionId}`);
            if (questionBlock) {
                questionBlock.classList.remove('missing');
                // Retirer aussi le style des labels
                const labels = questionBlock.querySelectorAll('.option-label');
                labels.forEach(label => label.classList.remove('missing-label'));
            }
            
            // Mettre à jour le compteur
            updateMissingQuestionsCount();
        }
    });
    
    document.getElementById('modal-lycam-test').style.display = 'flex';
    
    // Faire défiler vers le haut du modal
    container.scrollTop = 0;
}
function updateLycamProgress() {
    const totalQuestions = LYCAM_QUESTIONS.length;
    let answeredCount = 0;
    
    for(let i = 1; i <= totalQuestions; i++) {
        const selected = document.querySelector(`input[name="q_${i}"]:checked`);
        if(selected) answeredCount++;
    }
    
    const progressDiv = document.getElementById('lycam-progress');
    if (progressDiv) {
        const percentage = Math.round((answeredCount / totalQuestions) * 100);
        progressDiv.innerHTML = `
            <div style="display: flex; align-items: center; gap: 8px;">
                <div style="width: 60px; background: var(--border); height: 6px; border-radius: 3px; overflow: hidden;">
                    <div style="width: ${percentage}%; background: ${answeredCount === totalQuestions ? 'var(--accent)' : 'var(--lycam-color)'}; height: 100%;"></div>
                </div>
                <span>${answeredCount}/${totalQuestions}</span>
            </div>
        `;
    }
    
    return answeredCount;
    // Ajouter un écouteur pour retirer le style "missing" quand une réponse est sélectionnée
container.addEventListener('change', function(e) {
    if (e.target.type === 'radio') {
        const questionId = e.target.getAttribute('data-qid');
        const questionBlock = document.getElementById(`q-block-${questionId}`);
        if (questionBlock) {
            questionBlock.classList.remove('missing');
            // Retirer aussi le style des labels
            const labels = questionBlock.querySelectorAll('.option-label');
            labels.forEach(label => label.classList.remove('missing-label'));
        }
        
        // Mettre à jour le compteur et la progression
        updateMissingQuestionsCount();
        updateLycamProgress();
        
        // Cacher le message d'erreur si toutes les questions sont maintenant remplies
        const missingCount = updateMissingQuestionsCount();
        if (missingCount === 0) {
            const errorDiv = document.getElementById('lycam-error-message');
            if (errorDiv) errorDiv.style.display = 'none';
        }
    }
});
}

function submitLycamTest() {
    if(!currentLycamCandidate) return;
    
    const answers = {};
    let totalScore = 0;
    const dimensionScores = {};
    Object.keys(LYCAM_DIMENSIONS).forEach(k => dimensionScores[k] = 0);
    
    // Vérifier d'abord si toutes les questions sont renseignées
    const missingQuestions = [];
    
    for(let i = 1; i <= LYCAM_QUESTIONS.length; i++) {
        const selected = document.querySelector(`input[name="q_${i}"]:checked`);
        const val = selected ? selected.value : '';
        
        if (!val) {
            missingQuestions.push(i);
        }
    }
    
    // Si des questions manquent, mettre en évidence et empêcher la soumission
    if (missingQuestions.length > 0) {
        // Retirer d'abord tous les styles "missing"
        document.querySelectorAll('.question-block').forEach(block => {
            block.classList.remove('missing');
        });
        
        // Appliquer le style "missing" aux questions non renseignées
        missingQuestions.forEach(qId => {
            const questionBlock = document.getElementById(`q-block-${qId}`);
            if (questionBlock) {
                questionBlock.classList.add('missing');
                
                // Mettre aussi en évidence les labels
                const labels = questionBlock.querySelectorAll('.option-label');
                labels.forEach(label => label.classList.add('missing-label'));
            }
        });
        
        // Afficher un message d'erreur
        const errorDiv = document.getElementById('lycam-error-message');
        if (!errorDiv) {
            // Créer le message d'erreur s'il n'existe pas
            const modalHeader = document.querySelector('#modal-lycam-test .modal-content > div:first-child');
            const errorMsg = document.createElement('div');
            errorMsg.id = 'lycam-error-message';
            errorMsg.style.cssText = 'color:var(--danger);font-size:12px;margin-top:8px;padding:8px;background:rgba(239,68,68,0.1);border-radius:6px;border:1px solid rgba(239,68,68,0.3);';
            modalHeader.appendChild(errorMsg);
        }
        
        const errorMsg = document.getElementById('lycam-error-message');
        errorMsg.innerHTML = `<i class="fa fa-exclamation-triangle"></i> <strong>${missingQuestions.length} question(s) non renseignée(s)</strong> : ${missingQuestions.join(', ')}. Veuillez répondre à toutes les questions avant de valider.`;
        errorMsg.style.display = 'block';
        
        // Faire défiler vers la première question manquante
        const firstMissing = document.getElementById(`q-block-${missingQuestions[0]}`);
        if (firstMissing) {
            firstMissing.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }
        
        // Mettre à jour le compteur
        updateMissingQuestionsCount();
        
        return; // Ne pas soumettre le test
    }
    
    // Si toutes les questions sont renseignées, procéder au calcul
    for(let i = 1; i <= LYCAM_QUESTIONS.length; i++) {
        const selected = document.querySelector(`input[name="q_${i}"]:checked`);
        const val = selected ? selected.value : '';
        const risk = getRiskScore(i, val);
        const dim = LYCAM_QUESTIONS.find(q => q.id === i).dimension;
        
        totalScore += risk;
        if(dim) dimensionScores[dim] += risk;
        answers[i] = val;
    }

    const riskDimensions = [];
    Object.keys(dimensionScores).forEach(key => {
        if(dimensionScores[key] >= LYCAM_DIMENSIONS[key].threshold) riskDimensions.push(LYCAM_DIMENSIONS[key].label);
    });

    const result = {
        id: uuid(),
        matricule: currentLycamCandidate.matricule,
        at: new Date().toISOString(),
        answers: answers,
        totalScore: totalScore,
        dimensionScores: dimensionScores,
        riskDimensions: riskDimensions,
        reason: "Test complet"
    };

    allTestResults.push(result);
    storage.save('LYCAMTestResults', allTestResults);
    
    // Cacher le message d'erreur s'il existe
    const errorDiv = document.getElementById('lycam-error-message');
    if (errorDiv) errorDiv.style.display = 'none';
    
    document.getElementById('modal-lycam-test').style.display = 'none';
    renderLycamGlobal();
    renderLycamCandidates();
    
    // Afficher un message de succès
    setStatus(`Test LYCAM enregistré pour ${currentLycamCandidate.nom} ${currentLycamCandidate.prenoms} (Score: ${totalScore})`, 'success');
}

function updateMissingQuestionsCount() {
    const totalQuestions = LYCAM_QUESTIONS.length;
    let answeredCount = 0;
    
    for(let i = 1; i <= totalQuestions; i++) {
        const selected = document.querySelector(`input[name="q_${i}"]:checked`);
        if(selected) answeredCount++;
    }
    
    const missingCount = totalQuestions - answeredCount;
    const submitBtn = document.getElementById('btn-submit-lycam');
    
    if (missingCount === 0) {
        submitBtn.innerHTML = '<i class="fa fa-check-circle"></i> Valider le test';
        submitBtn.style.background = 'var(--lycam-color)';
    } else {
        submitBtn.innerHTML = `<i class="fa fa-exclamation-triangle"></i> Valider (${missingCount} manquante${missingCount > 1 ? 's' : ''})`;
        submitBtn.style.background = 'var(--danger)';
    }
    
    return missingCount;
}

function switchLycamView(view) {
    document.getElementById('lycam-view-candidates').style.display = (view === 'candidates') ? 'flex' : 'none';
    document.getElementById('lycam-view-results').style.display = (view === 'results') ? 'flex' : 'none';
    const tabs = document.querySelectorAll('#lycamMainPanel .tab');
    tabs.forEach(t => t.classList.remove('active'));
    if(view === 'candidates') tabs[0].classList.add('active');
    else tabs[1].classList.add('active');

    if(view === 'results') renderLycamGlobal();
    if(view === 'candidates') renderLycamCandidates();
}

function renderLycamCandidates() {
    const filterClass = document.getElementById('lycam-class-filter').value;
    const searchQuery = document.getElementById('lycam-search-candidate').value.toLowerCase();
    
    let candidates = allStudents;
    if (filterClass !== '__ALL__') candidates = candidates.filter(s => normalizeClasseKey(s.classe) === filterClass);
    if (searchQuery) candidates = candidates.filter(s => s.nom.toLowerCase().includes(searchQuery) || s.prenoms.toLowerCase().includes(searchQuery) || s.matricule.toLowerCase().includes(searchQuery));

    const tbody = document.querySelector('#lycam-candidates-table tbody');
    tbody.innerHTML = '';

    candidates.slice(0, 100).forEach(s => { 
        const existing = allTestResults.filter(t => t.matricule === s.matricule);
        const lastTest = existing.length > 0 ? existing.sort((a,b)=>b.at.localeCompare(a.at))[0] : null;
        
        let statusHtml = '<span class="badge" style="background:#f1f5f9;color:#94a3b8">Non testé</span>';
        if(lastTest) statusHtml = `<span class="badge" style="background:#e0e7ff;color:#4f46e5">Testé le ${fmtDate(lastTest.at)}</span>`;

        const tr = document.createElement('tr');
        tr.innerHTML = `
            <td style="font-family:'Courier New'">${s.matricule}</td>
            <td><b>${s.nom}</b> ${s.prenoms}</td>
            <td>${s.classe}</td>
            <td>${statusHtml}</td>
            <td><button class="btn lycam-btn btn-launch-test" style="padding:4px 8px;font-size:11px">Lancer Test</button></td>
        `;
        tr.querySelector('.btn-launch-test').onclick = (e) => { e.stopPropagation(); startLycamTest(s); };
        tbody.appendChild(tr);
    });
}

function renderLycamGlobal() {
    const tableBody = document.querySelector('#lycam-global-table tbody');
    tableBody.innerHTML = '';

    const studentTests = {};
    allTestResults.forEach(t => {
        if(!studentTests[t.matricule] || t.at > studentTests[t.matricule].at) {
            studentTests[t.matricule] = t;
        }
    });

    Object.values(studentTests).sort((a,b) => b.totalScore - a.totalScore).forEach(t => {
        const student = allStudents.find(s => s.matricule === t.matricule);
        if(!student) return;

        const score = t.totalScore !== undefined ? t.totalScore : (t.total || 0);
        const info = getLycamRiskInfo(score); // Utilise notre helper

        // Construction des dimensions (inchangé)
        let dimHtml = '';
        if(t.dimensionScores) {
            const dimKeys = ['AF','PS','RS','CS','AB','BS','IE'];
            dimHtml = dimKeys.map(k => {
                const val = t.dimensionScores[k] || 0;
                const isRisk = val >= LYCAM_DIMENSIONS[k].threshold;
                const colorStyle = isRisk ? 'background:#fee2e2;color:#dc2626;border-color:#fca5a5' : 'background:#dcfce7;color:#16a34a;border-color:#86efac';
                return `<div class="dim-score-box" style="${colorStyle}">${k}:${val}</div>`;
            }).join('');
        } else {
            dimHtml = '<span style="color:#94a3b8;font-size:11px">Ancien format</span>';
        }

        const tr = document.createElement('tr');
        // MODIFICATION ICI : Risque devant le score
        tr.innerHTML = `
            <td>
                <div style="font-weight:bold">${student.nom} ${student.prenoms}</div>
                <div style="font-size:11px;color:#64748b">${student.classe}</div>
            </td>
            <td style="text-align:center">
                <div style="display:flex; flex-direction:column; align-items:center; gap:4px">
                    <span class="badge" style="background:${info.bg}; color:${info.color}; border:1px solid ${info.border}; text-transform:uppercase; font-size:11px">
                        ${info.label}
                    </span>
                    <span style="font-weight:800; font-size:16px; color:var(--text)">Score : ${score}</span>
                </div>
            </td>
            <td>${dimHtml}</td>
            <td>${fmtDate(t.at)}</td>
            <td><button class="btn ghost btn-del-lycam"><i class="fa fa-trash"></i></button></td>
        `;
        tr.querySelector('.btn-del-lycam').onclick = () => deleteLycam(t.id);
        tableBody.appendChild(tr);
    });
}

/* ====== REGISTRY LOGIC ====== */
function renderRegistry() {
    const tbody = document.querySelector('#registry-table tbody');
    tbody.innerHTML = '';
    allRegistry.sort((a,b) => b.at.localeCompare(a.at)).forEach(r => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
            <td>${fmtDateTime(r.at)}</td>
            <td><span class="badge" style="background:#f1f5f9">${r.type}</span></td>
            <td><b>${r.name}</b></td>
            <td style="font-size:12px;color:var(--text-muted)">${r.contact}</td>
            <td>${r.reason}</td>
            <td><button class="btn ghost btn-del-reg"><i class="fa fa-trash"></i></button></td>
        `;
        tr.querySelector('.btn-del-reg').onclick = () => {
             if(confirm('Supprimer cette entrée ?')) {
                 allRegistry = allRegistry.filter(x => x.id !== r.id);
                 storage.save('GlobalRegistryData', allRegistry);
                 renderRegistry();
             }
        };
        tbody.appendChild(tr);
    });
}

function addRegistryEntry() {
    const dt = document.getElementById('reg-datetime').value;
    const name = document.getElementById('reg-name').value.trim();
    const type = document.getElementById('reg-type').value;
    const contact = document.getElementById('reg-contact').value.trim();
    const reason = document.getElementById('reg-reason').value.trim();

    if(!name || !reason) { alert("Nom et Motif obligatoires"); return; }
    const entry = { id: uuid(), at: dt || new Date().toISOString(), name: name, type: type, contact: contact, reason: reason };
    allRegistry.push(entry);
    storage.save('GlobalRegistryData', allRegistry);
    document.getElementById('reg-name').value = '';
    document.getElementById('reg-contact').value = '';
    document.getElementById('reg-reason').value = '';
    renderRegistry();
}

/* ====== TRACKING & COACHING GLOBAL LOGIC (NEW) ====== */
function switchTrackingView(view) {
    document.getElementById('track-view-visits').style.display = (view === 'visits') ? 'flex' : 'none';
    document.getElementById('track-view-coaching').style.display = (view === 'coaching') ? 'flex' : 'none';
    const tabs = document.querySelectorAll('#trackingGlobalPanel .tab');
    tabs.forEach(t => t.classList.remove('active'));
    if(view === 'visits') tabs[0].classList.add('active');
    else tabs[1].classList.add('active');
    renderGlobalTracking();
}

function renderGlobalTracking() {
    // 1. Visits
    const tbodyVisits = document.querySelector('#track-visits-table tbody');
    tbodyVisits.innerHTML = '';
    // Join with student data
    const richVisits = allVisits.map(v => {
        const s = allStudents.find(st => st.matricule === v.matricule);
        return { ...v, student: s };
    }).filter(x => x.student); // keep valid only
    
    richVisits.sort((a,b) => b.at.localeCompare(a.at)).forEach(v => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
            <td>${fmtDate(v.at)}</td>
            <td><b>${v.student.nom}</b> ${v.student.prenoms}</td>
            <td><span class="badge" style="background:var(--brand-light)">${v.student.classe}</span></td>
            <td>${v.details}</td>
        `;
        tr.onclick = () => openStudent(v.student);
        tbodyVisits.appendChild(tr);
    });

    // 2. Coaching
    const tbodyCoach = document.querySelector('#track-coaching-table tbody');
    tbodyCoach.innerHTML = '';
    const richCoach = coachingData.map(c => {
        const s = allStudents.find(st => st.matricule === c.matricule);
        return { ...c, student: s };
    }).filter(x => x.student);

    richCoach.sort((a,b) => b.at.localeCompare(a.at)).forEach(c => {
        let statusStyle = 'background:#f1f5f9;color:#64748b';
        if(c.status === 'En cours') statusStyle = 'background:#fef3c7;color:#d97706';
        if(c.status === 'Terminé') statusStyle = 'background:#dcfce7;color:#16a34a';
        if(c.status === 'Abandonné') statusStyle = 'background:#fee2e2;color:#dc2626';

        const tr = document.createElement('tr');
        tr.innerHTML = `
            <td>${fmtDate(c.at)}</td>
            <td><b>${c.student.nom}</b> ${c.student.prenoms}</td>
            <td><span class="badge" style="background:var(--brand-light)">${c.student.classe}</span></td>
            <td><span class="badge" style="${statusStyle}">${c.status}</span></td>
            <td>${c.actions}</td>
        `;
        tr.onclick = () => openStudent(c.student);
        tbodyCoach.appendChild(tr);
    });
}

// Helpers for individual student panel
function renderVisits(s){
  const tb = document.querySelector('#visits-table tbody'); tb.innerHTML = '';
  allVisits.filter(v => v.matricule === s.matricule).forEach(v => { tb.innerHTML += `<tr><td>${fmtDate(v.at)}</td><td>${v.details}</td></tr>`; });
}
function renderCoachings(s){
  const tb = document.querySelector('#coach-table tbody'); tb.innerHTML = '';
  coachingData.filter(c => c.matricule === s.matricule).forEach(c => { tb.innerHTML += `<tr><td>${fmtDate(c.at)}</td><td>${c.status}</td><td>${c.actions}</td></tr>`; });
}

/* ====== COMPREHENSIVE BACKUP LOGIC ====== */
async function exportFullBackup() {
    const backup = {
        meta: { date: new Date().toISOString(), version: '5.5', description: 'Sauvegarde complete GE' },
        localStorage: {
            LYCAMTestResults: storage.load('LYCAMTestResults', []),
            studentVisits: storage.load('studentVisits', []),
            LYCAMCoachingData: storage.load('LYCAMCoachingData', []),
            GlobalRegistryData: storage.load('GlobalRegistryData', [])
        },
        indexedDB: {}
    };

    // Grab all students from all years in DB
    const years = await studentsStore.listYears();
    for(const y of years) {
        backup.indexedDB[y] = await studentsStore.load(y);
    }

    const dataStr = JSON.stringify(backup, null, 2);
    const blob = new Blob([dataStr], { type: "application/json" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = `backup_ge_complet_${new Date().toISOString().slice(0,10)}.json`;
    a.click();
    URL.revokeObjectURL(url);
}

/* ====== STATISTIQUES GLOBALES CORRIGÉES ====== */

// Récupère la période choisie (1TR, 2TR, etc.)
function getStatsPeriod() {
    const el = document.getElementById('stats-period-selector');
    return el ? el.value : 'Annuelle';
}

function switchStatsView(view) {
    const views = ['overview', 'repartition', 'topbottom', 'gender', 'orientation'];
    views.forEach(v => {
        const el = document.getElementById(`stats-${v}`);
        if(el) el.style.display = 'none';
        
        const tab = document.querySelector(`#stats-tabs .tab[onclick*="${v}"]`);
        if(tab) tab.classList.remove('active');
    });
    
    const targetEl = document.getElementById(`stats-${view}`);
    if(targetEl) targetEl.style.display = 'block';
    
    const targetTab = document.querySelector(`#stats-tabs .tab[onclick*="${view}"]`);
    if(targetTab) targetTab.classList.add('active');
    
    // Rafraîchir la vue demandée
    if(view === 'overview') renderOverviewStats();
    else if(view === 'repartition') renderRepartitionStats();
    else if(view === 'topbottom') renderTopBottomStats();
    else if(view === 'gender') renderGenderStats();
    else if(view === 'orientation') renderOrientationStats();
}

// Recalculer quand on change la période
document.getElementById('stats-period-selector').addEventListener('change', () => {
    // Trouver l'onglet actif et recharger sa fonction
    const activeTab = document.querySelector('#stats-tabs .tab.active');
    if(activeTab) activeTab.click();
});

function calculateClassAverage(students, subjectKey, period) {
    let validNotes = 0;
    let sum = 0;
    students.forEach(s => {
        const note = getStudentNote(s, period, subjectKey);
        // MODIFICATION : Ajout de (note > 1) pour exclure 0 et 1
        if (note !== -1 && !isNaN(note) && note > 1) {
            sum += note;
            validNotes++;
        }
    });
    if (validNotes === 0) return null;
    return sum / validNotes;
}

function renderOverviewStats() {
    const container = document.getElementById('overview-content');
    const selectedClass = document.getElementById('class-filter').value;
    const period = getStatsPeriod(); // Utilisation dynamique
    
    const classes = selectedClass === '__ALL__' 
        ? [...new Set(allStudents.map(s => s.classe).filter(Boolean))].sort()
        : [selectedClass];
    
    let html = '<div class="stat-grid">';
    
    classes.forEach(cls => {
        const classStudents = allStudents.filter(s => normalizeClasseKey(s.classe) === normalizeClasseKey(cls));
        if(classStudents.length === 0) return;
        
        // Moyenne générale
        const generalAvg = calculateClassAverage(classStudents, 'Moy_generale', period);
        const displayAvg = generalAvg !== null ? generalAvg.toFixed(2) : '—';
        
        // Taux de réussite (Moyenne >= 10)
        const passedCount = classStudents.filter(s => getStudentNote(s, period, 'Moy_generale') >= 10).length;
        const successRate = generalAvg !== null ? Math.round((passedCount / classStudents.length) * 100) : 0;
        
        // Couleur dynamique
        let color = 'var(--text-muted)';
        if(generalAvg >= 12) color = 'var(--accent)';
        else if(generalAvg >= 10) color = 'var(--brand)';
        else if(generalAvg > 0) color = 'var(--danger)';

        html += `
            <div class="kpi-card">
                <div style="display:flex; justify-content:space-between; align-items:start; margin-bottom:10px;">
                    <h3 style="margin:0; color:var(--brand-dark)">${cls}</h3>
                    <span class="chip">${classStudents.length} élèves</span>
                </div>
                
                <div style="display:flex; gap:20px; align-items:center; margin-bottom:15px">
                    <div>
                        <div class="kpi-label">Moyenne Classe</div>
                        <div class="kpi-value" style="color:${color}">${displayAvg}</div>
                    </div>
                    <div style="flex:1">
                        <div class="kpi-label">Réussite (${passedCount}/${classStudents.length})</div>
                        <div style="display:flex; align-items:center; gap:8px">
                            <div class="stat-bar-container">
                                <div class="stat-bar-fill" style="width:${successRate}%; background:${successRate>=50?'var(--accent)':'var(--danger)'}"></div>
                            </div>
                            <span style="font-weight:bold; font-size:12px">${successRate}%</span>
                        </div>
                    </div>
                </div>

                <div style="font-size:12px; color:var(--text-muted); border-top:1px solid var(--border); padding-top:8px">
                    <strong>Période : ${period}</strong>
                </div>
            </div>
        `;
    });
    
    html += '</div>';
    container.innerHTML = html;
}

// NOUVELLE FONCTION : Histogramme de répartition
function renderRepartitionStats() {
    const container = document.getElementById('repartition-content');
    const selectedClass = document.getElementById('class-filter').value;
    const period = getStatsPeriod();
    
    let students = selectedClass === '__ALL__' ? allStudents : allStudents.filter(s => normalizeClasseKey(s.classe) === normalizeClasseKey(selectedClass));
    
    // Définir les tranches
    const ranges = [
        { label: '0 - 5,99', min: 0, max: 5.99, color: '#ef4444' },
        { label: '6 - 8,49', min: 6, max: 8.49, color: '#f97316' },
        { label: '8,5 - 9,99', min: 8.5, max: 9.99, color: '#eab308' },
        { label: '10 - 11,99', min: 10, max: 11.99, color: '#84cc16' },
        { label: '12 - 14,99', min: 12, max: 14.99, color: '#22c55e' },
        { label: '15 et +', min: 15, max: 20, color: '#06b6d4' }
    ];
    
    // Compter
    const counts = ranges.map(r => 0);
    let totalWithGrades = 0;
    
    students.forEach(s => {
        const avg = getStudentNote(s, period, 'Moy_generale');
        
        // MODIFICATION : On ne compte que si la moyenne est strictement supérieure à 1
        if(avg > 1) {
            totalWithGrades++;
            const idx = ranges.findIndex(r => avg >= r.min && avg <= r.max);
            if(idx !== -1) counts[idx]++;
        }
    });

    if(totalWithGrades === 0) {
        container.innerHTML = `<div style="padding:20px; text-align:center; color:var(--text-muted)">Aucune note trouvée pour la période <b>${period}</b>.</div>`;
        return;
    }

    let html = `<div class="card"><h4 style="margin-top:0">Répartition des Moyennes Générales (${period})</h4><div style="display:flex; flex-direction:column; gap:12px;">`;
    
    ranges.forEach((r, idx) => {
        const count = counts[idx];
        const pct = ((count / totalWithGrades) * 100).toFixed(1);
        
        html += `
            <div>
                <div style="display:flex; justify-content:space-between; font-size:12px; margin-bottom:4px">
                    <span style="font-weight:600">${r.label}</span>
                    <span>${count} élèves (${pct}%)</span>
                </div>
                <div class="stat-bar-container" style="height:12px; margin-top:0">
                    <div class="stat-bar-fill" style="width:${pct}%; background:${r.color}"></div>
                </div>
            </div>
        `;
    });
    
    html += '</div></div>';
    container.innerHTML = html;
}

function renderTopBottomStats() {
    const container = document.getElementById('topbottom-content');
    const selectedClass = document.getElementById('class-filter').value;
    const period = getStatsPeriod();
    
    const classStudents = selectedClass === '__ALL__' 
        ? allStudents
        : allStudents.filter(s => normalizeClasseKey(s.classe) === normalizeClasseKey(selectedClass));
    
// Dans renderTopBottomStats, remplacez la ligne sortedStudents :
    const sortedStudents = classStudents
        .map(s => ({ ...s, val: getStudentNote(s, period, 'Moy_generale') }))
        // MODIFICATION : Filtre > 1
        .filter(s => s.val !== -1 && !isNaN(s.val) && s.val > 1)
        .sort((a, b) => b.val - a.val);
        
    if(sortedStudents.length === 0) {
        container.innerHTML = `<div style="padding:20px; text-align:center">Aucune donnée pour ${period}</div>`;
        return;
    }
    
    const top10 = sortedStudents.slice(0, 10);
    const bottom10 = sortedStudents.slice(-10).reverse(); // Pire en haut de la liste bottom

    // Fonction helper pour générer table
    const makeTable = (list, title, colorIcon) => {
        let h = `<div class="card" style="flex:1"><h4 style="margin-top:0; border-bottom:1px solid var(--border); padding-bottom:10px"><i class="fa ${colorIcon}"></i> ${title} (${period})</h4>
        <div class="table-wrap"><table style="font-size:12px"><thead><tr><th>#</th><th>Nom</th><th>Classe</th><th>Moy</th></tr></thead><tbody>`;
        list.forEach((s, i) => {
            h += `<tr onclick="openStudent(allStudents.find(x=>x.id=='${s.id}'))">
                <td>${i+1}</td>
                <td><b>${s.nom}</b> ${s.prenoms.substring(0,10)}...</td>
                <td><span class="badge">${s.classe}</span></td>
                <td style="font-weight:bold">${s.val.toFixed(2)}</td>
            </tr>`;
        });
        h += `</tbody></table></div></div>`;
        return h;
    };

    container.innerHTML = `<div style="display:flex; flex-wrap:wrap; gap:16px">
        ${makeTable(top10, 'Les Meilleurs', 'fa-trophy" style="color:var(--warn)')}
        ${makeTable(bottom10, 'En Difficulté', 'fa-arrow-down" style="color:var(--danger)')}
    </div>`;
}

function renderGenderStats() {
    const container = document.getElementById('gender-content');
    const selectedClass = document.getElementById('class-filter').value;
    const period = getStatsPeriod();
    
    const classStudents = selectedClass === '__ALL__' 
        ? allStudents
        : allStudents.filter(s => normalizeClasseKey(s.classe) === normalizeClasseKey(selectedClass));
    
    const male = classStudents.filter(s => s.sexe === 'M');
    const female = classStudents.filter(s => s.sexe === 'F');
    
    const calcAvg = (list) => calculateClassAverage(list, 'Moy_generale', period) || 0;
    const avgM = calcAvg(male);
    const avgF = calcAvg(female);
    
    container.innerHTML = `
        <div class="stat-grid" style="margin-bottom:20px">
            <div class="kpi-card" style="text-align:center">
                <i class="fa fa-female" style="font-size:30px; color:#ec4899"></i>
                <div class="kpi-value">${avgF.toFixed(2)}</div>
                <div class="kpi-label">Moyenne Filles (${female.length})</div>
            </div>
            <div class="kpi-card" style="text-align:center">
                <i class="fa fa-male" style="font-size:30px; color:#3b82f6"></i>
                <div class="kpi-value">${avgM.toFixed(2)}</div>
                <div class="kpi-label">Moyenne Garçons (${male.length})</div>
            </div>
        </div>
        <div class="card" style="padding:10px; background:var(--brand-light); text-align:center; font-size:13px">
            Basé sur les données : <b>${period}</b>
        </div>
    `;
}

function renderOrientationStats() {
    const container = document.getElementById('orientation-content');
    const period = getStatsPeriod();
    
    // Filtrer Cycle 1
    const students = allStudents.filter(s => (s.classe||'').match(/^(6|5|4|3)/));
    const subjects = ['maths','physique','anglais','francais'];
    
    let html = `<div style="margin-bottom:10px;font-size:12px;color:var(--text-muted)">Période: ${period} | Élèves concernés: ${students.length} (6e à 3e)</div>
    <div class="stat-grid">`;
    
    subjects.forEach(sub => {
        const avg = calculateClassAverage(students, sub, period) || 0;
        // Compter ceux qui ont la moyenne
        const ok = students.filter(s => getStudentNote(s, period, sub) >= 10).length;
        const pct = ((ok/students.length)*100).toFixed(0);
        
        html += `
        <div class="kpi-card">
            <div style="font-weight:bold; margin-bottom:8px; text-transform:capitalize">${sub}</div>
            <div class="kpi-value" style="color:${avg>=10?'var(--accent)':'var(--danger)'}">${avg.toFixed(2)}</div>
            <div class="stat-bar-container">
                <div class="stat-bar-fill" style="width:${pct}%; background:var(--brand)"></div>
            </div>
            <div style="font-size:11px; margin-top:4px">${ok} élèves ≥ 10 (${pct}%)</div>
        </div>`;
    });
    
    html += '</div>';
    container.innerHTML = html;
}

async function importFullBackup(file) {
    if(!confirm("ATTENTION : Cette action va écraser/fusionner les données existantes. Voulez-vous continuer ?")) {
        document.getElementById('input-import-backup').value = '';
        return;
    }
    
    try {
        const text = await file.text();
        const data = JSON.parse(text);

        if(!data.meta || !data.localStorage || !data.indexedDB) throw new Error("Format de sauvegarde invalide.");

        // Restore LocalStorage
        Object.keys(data.localStorage).forEach(k => {
            storage.save(k, data.localStorage[k]);
        });

        // Restore IndexedDB
        for(const year of Object.keys(data.indexedDB)) {
            await studentsStore.save(year, data.indexedDB[year]);
        }

        alert("Restauration complète effectuée avec succès ! La page va se recharger.");
        location.reload();

    } catch(e) {
        alert("Erreur lors de la restauration : " + e.message);
    }
    document.getElementById('input-import-backup').value = '';
}

document.addEventListener('DOMContentLoaded', async () => {
  document.querySelectorAll('#studentPanel .tab').forEach(t => {
    t.addEventListener('click', () => {
      document.querySelectorAll('#studentPanel .tab').forEach(x=>x.classList.remove('active'));
      t.classList.add('active');
      document.querySelectorAll('#studentPanel > div[id^="tab-"]').forEach(d=>d.style.display='none');
      document.getElementById('tab-'+t.dataset.tab).style.display = 'block';
    });
  });
// Ouvrir les statistiques
document.getElementById('btn-open-stats').addEventListener('click', () => {
    document.querySelectorAll('.section').forEach(p => p.style.display = 'none');
    document.getElementById('statsPanel').style.display = 'flex';
    document.getElementById('statsPanel').style.flexDirection = 'column';
    renderOverviewStats();
});

// Mettre à jour les statistiques quand on change de classe
document.getElementById('class-filter').addEventListener('change', () => {
    if(document.getElementById('statsPanel').style.display === 'flex') {
        renderOverviewStats();
    }
});
  await loadGlobalData();
  await loadStudentsForYear();
  
  // Ajoutez cette fonction après le DOMContentLoaded
function setupMobileTabs() {
  const tabsContainers = document.querySelectorAll('.tabs');
  
  tabsContainers.forEach(container => {
    let isDown = false;
    let startX;
    let scrollLeft;
    
    container.addEventListener('mousedown', (e) => {
      isDown = true;
      startX = e.pageX - container.offsetLeft;
      scrollLeft = container.scrollLeft;
      container.style.cursor = 'grabbing';
    });
    
    container.addEventListener('mouseleave', () => {
      isDown = false;
      container.style.cursor = 'grab';
    });
    
    container.addEventListener('mouseup', () => {
      isDown = false;
      container.style.cursor = 'grab';
    });
    
    container.addEventListener('mousemove', (e) => {
      if(!isDown) return;
      e.preventDefault();
      const x = e.pageX - container.offsetLeft;
      const walk = (x - startX) * 2;
      container.scrollLeft = scrollLeft - walk;
    });
    
    // Touch events pour mobile
    container.addEventListener('touchstart', (e) => {
      isDown = true;
      startX = e.touches[0].pageX - container.offsetLeft;
      scrollLeft = container.scrollLeft;
    });
    
    container.addEventListener('touchend', () => {
      isDown = false;
    });
    
    container.addEventListener('touchmove', (e) => {
      if(!isDown) return;
      const x = e.touches[0].pageX - container.offsetLeft;
      const walk = (x - startX) * 2;
      container.scrollLeft = scrollLeft - walk;
    });
  });
}

// Appelez cette fonction dans DOMContentLoaded
document.addEventListener('DOMContentLoaded', async () => {
  // ... votre code existant ...
  
  // Ajoutez cette ligne à la fin
  setupMobileTabs();
});

  document.getElementById('school-year').addEventListener('change', async () => {
    await loadStudentsForYear();
  });
  document.getElementById('excel-file').addEventListener('change', e => { if(e.target.files[0]) handleExcel(e.target.files[0]); });
  
  // Navigation
  document.getElementById('backToListBtn').addEventListener('click', leaveDetailMode);
  document.querySelectorAll('.close-panel').forEach(b => b.addEventListener('click', leaveDetailMode));
  
  document.getElementById('btn-open-rankings').addEventListener('click', () => {
    document.querySelectorAll('.section').forEach(p => p.style.display = 'none');
    document.getElementById('rankingsPanel').style.display = 'flex';
    document.getElementById('rankingsPanel').style.flexDirection = 'column';
    const mainSel = document.getElementById('class-filter');
    const rankSel = document.getElementById('rank-class-filter');
    rankSel.innerHTML = '';
    Array.from(mainSel.options).forEach(opt => { if(opt.value !== '__ALL__') rankSel.add(new Option(opt.text, opt.value)); });
    if(mainSel.value !== '__ALL__') rankSel.value = mainSel.value;
    renderRankingsToContainer('rankings-container');
  });

  document.getElementById('btn-open-lycam-main').addEventListener('click', () => {
    document.querySelectorAll('.section').forEach(p => p.style.display = 'none');
    document.getElementById('lycamMainPanel').style.display = 'flex';
    document.getElementById('lycamMainPanel').style.flexDirection = 'column';
    populateClassFilter(); 
    switchLycamView('candidates');
  });

  document.getElementById('btn-open-registry').addEventListener('click', () => {
     document.querySelectorAll('.section').forEach(p => p.style.display = 'none');
     document.getElementById('registryPanel').style.display = 'flex';
     document.getElementById('registryPanel').style.flexDirection = 'column';
     const now = new Date();
     now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
     document.getElementById('reg-datetime').value = now.toISOString().slice(0,16);
     renderRegistry();
  });

  // Open Tracking
  document.getElementById('btn-open-tracking').addEventListener('click', () => {
     document.querySelectorAll('.section').forEach(p => p.style.display = 'none');
     document.getElementById('trackingGlobalPanel').style.display = 'flex';
     document.getElementById('trackingGlobalPanel').style.flexDirection = 'column';
     switchTrackingView('visits');
  });
  
  // Backup events
  document.getElementById('btn-export-backup').addEventListener('click', exportFullBackup);
  document.getElementById('input-import-backup').addEventListener('change', (e) => {
      if(e.target.files[0]) importFullBackup(e.target.files[0]);
  });

  document.getElementById('btn-add-registry').addEventListener('click', addRegistryEntry);
  document.getElementById('class-filter').addEventListener('change', () => renderRoster());
  document.getElementById('refresh-roster').addEventListener('click', () => renderRoster());
  document.getElementById('search').addEventListener('input', (e) => {
    const q = e.target.value.toLowerCase();
    const res = allStudents.filter(s => s.nom.toLowerCase().includes(q) || s.prenoms.toLowerCase().includes(q) || s.matricule.toLowerCase().includes(q));
    renderRoster(res);
  });
  
  document.getElementById('rank-class-filter').addEventListener('change', () => renderRankingsToContainer('rankings-container'));
  document.getElementById('subject-filter').addEventListener('change', () => renderRankingsToContainer('rankings-container'));
  document.getElementById('rank-scope').addEventListener('change', () => renderRankingsToContainer('rankings-container'));

  document.getElementById('lycam-class-filter').addEventListener('change', () => renderLycamCandidates());
  document.getElementById('lycam-search-candidate').addEventListener('input', () => renderLycamCandidates());

  document.getElementById('btn-add-student').addEventListener('click', () => document.getElementById('modal-add-student').style.display = 'flex');
  document.getElementById('btn-cancel-add').addEventListener('click', () => document.getElementById('modal-add-student').style.display = 'none');
  document.getElementById('btn-submit-add').addEventListener('click', async () => {
    const form = document.getElementById('form-add-student');
    const fd = new FormData(form);
    allStudents.push({ id: uuid(), matricule: fd.get('matricule'), nom: fd.get('nom'), prenoms: fd.get('prenoms'), sexe: fd.get('sexe'), dateNaissance: fd.get('dateNaissance'), classe: fd.get('classe'), moyennes: {'Annuelle':{}}, rangs: {'Annuelle':''} });
    await studentsStore.save(getSelectedYear(), allStudents);
    document.getElementById('modal-add-student').style.display = 'none'; form.reset(); renderRoster();
  });
document.getElementById('btn-cancel-lycam').addEventListener('click', () => {
    // Réinitialiser les styles
    document.querySelectorAll('.question-block').forEach(block => {
        block.classList.remove('missing');
    });
    document.getElementById('modal-lycam-test').style.display = 'none';
});
  document.getElementById('btn-submit-lycam').addEventListener('click', submitLycamTest);

  document.getElementById('btn-add-visit').addEventListener('click', () => {
    if(!currentStudent) return;
    allVisits.push({ id: uuid(), matricule: currentStudent.matricule, at: document.getElementById('visit-at').value || new Date().toISOString(), details: document.getElementById('visit-details').value });
    storage.save('studentVisits', allVisits); renderVisits(currentStudent); document.getElementById('visit-reason').value=''; document.getElementById('visit-details').value='';
  });
  document.getElementById('btn-save-coach').addEventListener('click', () => {
    if(!currentStudent) return;
    coachingData.push({ id: uuid(), matricule: currentStudent.matricule, at: new Date().toISOString(), status: document.getElementById('coach-status').value, actions: document.getElementById('coach-actions').value });
    storage.save('LYCAMCoachingData', coachingData); renderCoachings(currentStudent); document.getElementById('coach-actions').value='';
  });
  document.getElementById('btn-generate-demo').addEventListener('click', () => {
    if(confirm("Générer des données fictives ? Cela remplacera les données existantes.")) {
        generateDummyData();
    }
});
});

</script>
</body>
</html>